<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Sankey de Energ√≠a</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* Header styles */
        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            color: #34495e;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Controls container */
        .controls-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Label styles */
        label {
            font-size: 1rem;
            font-weight: 500;
            color: #34495e;
            white-space: nowrap;
        }

        /* Select dropdown styles */
        select {
            font-family: inherit;
            font-size: 1rem;
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        select:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Diagram container */
        .diagram-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 95%;
            margin: 0 auto;
        }

        #sankey-diagram {
            width: 100%;
            height: 85vh;
            min-height: 600px;
            border-radius: 12px;
            overflow: hidden;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
                margin-bottom: 20px;
            }

            .controls-container {
                padding: 15px 20px;
                margin-bottom: 20px;
                flex-direction: column;
                gap: 10px;
            }

            .diagram-container {
                width: 98%;
                padding: 15px;
            }

            #sankey-diagram {
                height: 75vh;
                min-height: 500px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.75rem;
            }

            .controls-container {
                padding: 12px 15px;
            }

            .diagram-container {
                width: 100%;
                padding: 12px;
            }

            #sankey-diagram {
                height: 70vh;
                min-height: 450px;
            }

            select {
                font-size: 0.9rem;
                padding: 8px 12px;
                min-width: 100px;
            }
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Error state */
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            body {
                background: white;
                color: black;
            }

            .controls-container,
            .diagram-container {
                background: white;
                border: 2px solid black;
            }

            select {
                border: 2px solid black;
            }
        }

        /* Column Labels Controls Styles */
        .column-labels-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-labels-controls label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }

        .column-labels-controls input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #3498db;
        }

        /* Column Label Styles */
        .column-label {
            position: absolute;
            z-index: 1000;
            pointer-events: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .column-label-title {
            margin: 0;
            line-height: 1.2;
            font-weight: 600;
        }

        .column-label-description {
            margin: 2px 0 0 0;
            line-height: 1.1;
            opacity: 0.7;
            font-size: 0.8em;
        }

        /* Export Controls Styles */
        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-btn {
            font-family: inherit;
            font-size: 0.9rem;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .config-btn {
            background: #6c757d;
            color: white;
        }

        .config-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .png-btn {
            background: #28a745;
            color: white;
        }

        .png-btn:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .svg-btn {
            background: #007bff;
            color: white;
        }

        .svg-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 25px;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .config-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #495057;
        }

        .config-group input[type="number"],
        .config-group input[type="text"],
        .config-group select {
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .config-group input[type="number"]:focus,
        .config-group input[type="text"]:focus,
        .config-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .config-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Progress Modal Styles */
        .progress-modal {
            max-width: 400px;
            text-align: center;
        }

        .progress-content {
            padding: 30px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .progress-content p {
            margin: 0 0 20px 0;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Responsive adjustments for export controls */
        @media (max-width: 768px) {
            .export-controls {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }

            .export-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        @media (max-width: 480px) {
            .export-controls {
                flex-direction: column;
                gap: 8px;
            }

            .export-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: #ecf0f1;
            }

            h1 {
                color: #ecf0f1;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .controls-container,
            .diagram-container {
                background: rgba(44, 62, 80, 0.95);
                border: 1px solid rgba(236, 240, 241, 0.1);
            }

            label {
                color: #ecf0f1;
            }

            select {
                background: #34495e;
                color: #ecf0f1;
                border-color: #4a6741;
            }

            select:hover {
                border-color: #5dade2;
            }

            .error {
                background: #4a2c2a;
                border-color: #8b4513;
                color: #ff6b6b;
            }

            .modal-content {
                background: #34495e;
                color: #ecf0f1;
            }

            .modal-header {
                border-bottom-color: #4a6741;
            }

            .modal-header h3 {
                color: #ecf0f1;
            }

            .modal-footer {
                border-top-color: #4a6741;
            }

            .config-section h4 {
                color: #ecf0f1;
            }

            .config-group label {
                color: #ecf0f1;
            }

            .config-group input[type="number"],
            .config-group input[type="text"],
            .config-group select {
                background: #2c3e50;
                color: #ecf0f1;
                border-color: #4a6741;
            }

            .progress-content h3 {
                color: #ecf0f1;
            }

            .progress-content p {
                color: #bdc3c7;
            }
        }
    </style>
</head>

<body>
    <h1>Diagrama de Sankey de Energ√≠a en M√©xico</h1>
    <div class="controls-container">
        <label for="year-selector">Selecciona un a√±o:</label>
        <select id="year-selector"></select>

        <!-- Column Labels Controls -->
        <div class="column-labels-controls">
            <label>
                <input type="checkbox" id="column-labels-toggle">
                Mostrar etiquetas de columnas
            </label>
            <button id="add-example-labels-btn" class="export-btn config-btn"
                style="font-size: 0.8rem; padding: 6px 12px;">
                + Agregar Ejemplos
            </button>
            <button id="clear-labels-btn" class="export-btn"
                style="background: #dc3545; color: white; font-size: 0.8rem; padding: 6px 12px;">
                üóëÔ∏è Limpiar
            </button>
        </div>

        <!-- Export Controls -->
        <div class="export-controls">
            <button id="export-config-btn" class="export-btn config-btn">‚öôÔ∏è Configurar Exportaci√≥n</button>
            <button id="export-png-btn" class="export-btn png-btn">üì∑ Exportar PNG</button>
            <button id="export-svg-btn" class="export-btn svg-btn">üìÑ Exportar SVG</button>
        </div>
    </div>

    <!-- Export Configuration Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci√≥n de Exportaci√≥n</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h4>Resoluci√≥n PNG</h4>
                    <div class="config-group">
                        <label for="png-width">Ancho (px):</label>
                        <input type="number" id="png-width" value="1920" min="800" max="4000" step="100">
                    </div>
                    <div class="config-group">
                        <label for="png-height">Alto (px):</label>
                        <input type="number" id="png-height" value="1080" min="600" max="3000" step="100">
                    </div>
                    <div class="config-group">
                        <label for="png-scale">Escala:</label>
                        <select id="png-scale">
                            <option value="1">1x (Normal)</option>
                            <option value="2" selected>2x (Alta calidad)</option>
                            <option value="3">3x (Muy alta calidad)</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Opciones Generales</h4>
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="transparent-bg" checked>
                            Fondo transparente (PNG)
                        </label>
                    </div>
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="include-column-labels" checked>
                            Incluir etiquetas de columnas en exportaci√≥n
                        </label>
                    </div>
                    <div class="config-group">
                        <label for="filename-prefix">Prefijo del archivo:</label>
                        <input type="text" id="filename-prefix" value="sankey_energia" placeholder="sankey_energia">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-config-btn" class="btn-primary">Guardar Configuraci√≥n</button>
                <button id="cancel-config-btn" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Export Progress Modal -->
    <div id="export-progress-modal" class="modal">
        <div class="modal-content progress-modal">
            <div class="progress-content">
                <div class="spinner"></div>
                <h3 id="progress-title">Exportando...</h3>
                <p id="progress-message">Preparando imagen para descarga</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="diagram-container">
        <div id="sankey-diagram"></div>
    </div>

    <!-- Incluir los m√≥dulos -->
    <script src="js/DataManager.js"></script>
    <script src="js/StyleManager.js"></script>
    <script src="js/LayoutEngine.js"></script>
    <script src="js/NodeFactory.js"></script>
    <script src="js/LinkManager.js"></script>
    <script src="js/PopupManager.js"></script>
    <script src="js/ExportManager.js"></script>
    <script src="js/ColumnLabelsManager.js"></script>

    <script>
        const yearSelector = document.getElementById('year-selector');
        const sankeyDiv = document.getElementById('sankey-diagram');
        let dataManager = null;
        let styleManager = null;
        let layoutEngine = null;
        let nodeFactory = null;
        let linkManager = null;
        let popupManager = null;
        let exportManager = null;
        let columnLabelsManager = null;

        // Cargar los datos desde el archivo JSON y inicializar DataManager
        fetch('datos_energia_completo.json')
            .then(response => response.json())
            .then(data => {
                try {
                    // Inicializar DataManager con los datos cargados
                    dataManager = new DataManager(data);

                    // Inicializar StyleManager
                    styleManager = new StyleManager();

                    // Inicializar LayoutEngine
                    layoutEngine = new LayoutEngine();

                    // Inicializar LinkManager con referencias a otros m√≥dulos
                    linkManager = new LinkManager({
                        dataManager: dataManager,
                        styleManager: styleManager,
                        nodeFactory: null, // Se asignar√° despu√©s
                        popupManager: null // Se asignar√° despu√©s
                    });

                    // Inicializar NodeFactory con referencias a otros m√≥dulos
                    nodeFactory = new NodeFactory({
                        dataManager: dataManager,
                        styleManager: styleManager,
                        layoutEngine: layoutEngine,
                        linkManager: linkManager
                    });

                    // Asignar NodeFactory al LinkManager
                    linkManager.nodeFactory = nodeFactory;

                    // Inicializar PopupManager con referencias a otros m√≥dulos
                    popupManager = new PopupManager({
                        dataManager: dataManager,
                        styleManager: styleManager,
                        nodeFactory: nodeFactory
                    });

                    // Asignar PopupManager al LinkManager
                    linkManager.popupManager = popupManager;

                    // Inicializar ColumnLabelsManager con referencias a otros m√≥dulos
                    columnLabelsManager = new ColumnLabelsManager({
                        enabled: false, // Inicialmente deshabilitado
                        layoutEngine: layoutEngine,
                        styleManager: styleManager
                    });

                    // Aplicar tema por defecto y estilos de popup
                    styleManager.applyTheme();
                    popupManager.applyPopupStyles();

                    // Mostrar estad√≠sticas de los datos cargados
                    const stats = dataManager.getDataStats();
                    console.log('Datos cargados:', stats);
                    console.log('StyleManager inicializado con', Object.keys(styleManager.getAllColors()).length, 'colores');

                    // Mostrar estad√≠sticas del LayoutEngine
                    const layoutStats = layoutEngine.getLayoutStats();
                    console.log('LayoutEngine inicializado con', layoutStats.totalColumns, 'columnas');

                    // Mostrar estad√≠sticas del NodeFactory
                    const nodeFactoryStats = nodeFactory.getNodeStats();
                    console.log('NodeFactory inicializado con', nodeFactory.getRegisteredTypes().length, 'tipos de nodos registrados');

                    populateYearSelector();
                    // Inicializar controles de etiquetas de columnas
                    initializeColumnLabelsControls();
                    // Inicializar el gr√°fico con el primer a√±o disponible
                    updateSankey(yearSelector.value);

                    // Inicializar ExportManager despu√©s de que el diagrama est√© listo
                    setTimeout(() => {
                        try {
                            exportManager = new ExportManager(sankeyDiv, exportConfig, columnLabelsManager);
                            console.log('ExportManager inicializado correctamente con soporte para etiquetas de columnas');
                        } catch (error) {
                            console.error('Error inicializando ExportManager:', error);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error al inicializar DataManager:', error);
                    alert('Error al cargar los datos. Por favor, recarga la p√°gina.');
                }
            })
            .catch(error => {
                console.error('Error al cargar el JSON:', error);
                alert('Error al cargar el archivo de datos. Verifica que el archivo existe.');
            });

        // Poblar el selector de a√±os din√°micamente usando DataManager
        function populateYearSelector() {
            if (!dataManager) {
                console.error('DataManager no est√° inicializado');
                return;
            }

            // Usar el m√©todo del DataManager para obtener a√±os disponibles
            const sortedYears = dataManager.getAvailableYears();

            // Limpiar opciones existentes
            yearSelector.innerHTML = '';

            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            });

            // A√±adir el evento para actualizar el gr√°fico cuando cambia el a√±o
            yearSelector.addEventListener('change', (event) => {
                updateSankey(event.target.value);
            });
        }

        // Export Configuration Management
        let exportConfig = {
            png: {
                width: 1920,
                height: 1080,
                scale: 2
            },
            transparentBg: true,
            includeColumnLabels: true,
            filenamePrefix: 'sankey_energia'
        };

        // Initialize export functionality
        function initializeExportControls() {
            const exportConfigBtn = document.getElementById('export-config-btn');
            const exportPngBtn = document.getElementById('export-png-btn');
            const exportSvgBtn = document.getElementById('export-svg-btn');
            const exportModal = document.getElementById('export-modal');
            const exportProgressModal = document.getElementById('export-progress-modal');
            const closeBtn = document.querySelector('.close');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const cancelConfigBtn = document.getElementById('cancel-config-btn');

            // Open configuration modal
            exportConfigBtn.addEventListener('click', () => {
                loadConfigToModal();
                exportModal.style.display = 'block';
            });

            // Close modal events
            closeBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });

            cancelConfigBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });

            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === exportModal) {
                    exportModal.style.display = 'none';
                }
                if (event.target === exportProgressModal) {
                    exportProgressModal.style.display = 'none';
                }
            });

            // Save configuration
            saveConfigBtn.addEventListener('click', () => {
                saveConfigFromModal();
                exportModal.style.display = 'none';
            });

            // Export PNG
            exportPngBtn.addEventListener('click', () => {
                exportDiagram('png');
            });

            // Export SVG
            exportSvgBtn.addEventListener('click', () => {
                exportDiagram('svg');
            });
        }

        // Load current config to modal
        function loadConfigToModal() {
            document.getElementById('png-width').value = exportConfig.png.width;
            document.getElementById('png-height').value = exportConfig.png.height;
            document.getElementById('png-scale').value = exportConfig.png.scale;
            document.getElementById('transparent-bg').checked = exportConfig.transparentBg;
            document.getElementById('include-column-labels').checked = exportConfig.includeColumnLabels !== false;
            document.getElementById('filename-prefix').value = exportConfig.filenamePrefix;
        }

        // Save config from modal
        function saveConfigFromModal() {
            exportConfig.png.width = parseInt(document.getElementById('png-width').value);
            exportConfig.png.height = parseInt(document.getElementById('png-height').value);
            exportConfig.png.scale = parseInt(document.getElementById('png-scale').value);
            exportConfig.transparentBg = document.getElementById('transparent-bg').checked;
            exportConfig.includeColumnLabels = document.getElementById('include-column-labels').checked;
            exportConfig.filenamePrefix = document.getElementById('filename-prefix').value || 'sankey_energia';

            // Update ExportManager configuration if it's initialized
            if (exportManager) {
                exportManager.updateConfig(exportConfig);
                console.log('ExportManager configuration updated:', exportConfig);
            }
        }

        // Show progress modal
        function showProgressModal(format) {
            const progressModal = document.getElementById('export-progress-modal');
            const progressTitle = document.getElementById('progress-title');
            const progressMessage = document.getElementById('progress-message');
            const progressFill = document.getElementById('progress-fill');

            progressTitle.textContent = `Exportando ${format.toUpperCase()}...`;
            progressMessage.textContent = 'Preparando imagen para descarga';
            progressFill.style.width = '0%';
            progressModal.style.display = 'block';

            return {
                updateProgress: (percent, message) => {
                    progressFill.style.width = `${percent}%`;
                    if (message) progressMessage.textContent = message;
                },
                close: () => {
                    progressModal.style.display = 'none';
                }
            };
        }

        // Export diagram function using ExportManager
        async function exportDiagram(format) {
            if (!exportManager) {
                alert('ExportManager no est√° inicializado. Por favor, espera a que se cargue completamente.');
                return;
            }

            if (!exportManager.isDiagramReady()) {
                alert('El diagrama no est√° listo para exportar. Por favor, espera a que se cargue completamente.');
                return;
            }

            const progress = showProgressModal(format);
            const currentYear = yearSelector.value;

            try {
                // Disable export buttons during export
                setExportButtonsState(false);

                // Update ExportManager configuration
                exportManager.updateConfig(exportConfig);

                // Prepare export options with current year in filename
                const exportOptions = {
                    filename: `${exportConfig.filenamePrefix}_${currentYear}`
                };

                let result;
                if (format === 'png') {
                    // Export PNG using ExportManager
                    result = await exportManager.exportToPNG(exportOptions, (percent, message) => {
                        progress.updateProgress(percent, message);
                    });
                } else if (format === 'svg') {
                    // Export SVG using ExportManager
                    result = await exportManager.exportToSVG(exportOptions, (percent, message) => {
                        progress.updateProgress(percent, message);
                    });
                } else {
                    throw new Error(`Formato no soportado: ${format}`);
                }

                // Show success message
                console.log(`Exportaci√≥n ${format.toUpperCase()} exitosa:`, result);

                // Close progress modal after a short delay
                setTimeout(() => {
                    progress.close();
                }, 1000);

            } catch (error) {
                console.error('Error durante la exportaci√≥n:', error);
                progress.close();

                let errorMessage = 'Error desconocido durante la exportaci√≥n';
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }

                alert(`Error al exportar ${format.toUpperCase()}: ${errorMessage}`);
            } finally {
                // Re-enable export buttons
                setExportButtonsState(true);
            }
        }

        // Enable/disable export buttons
        function setExportButtonsState(enabled) {
            const exportButtons = document.querySelectorAll('.export-btn');
            exportButtons.forEach(btn => {
                btn.disabled = !enabled;
            });
        }

        // Initialize column labels controls
        function initializeColumnLabelsControls() {
            const columnLabelsToggle = document.getElementById('column-labels-toggle');

            if (!columnLabelsToggle) {
                console.warn('Column labels toggle not found');
                return;
            }

            // Add event listener for toggle
            columnLabelsToggle.addEventListener('change', (event) => {
                const enabled = event.target.checked;

                if (columnLabelsManager) {
                    columnLabelsManager.setEnabled(enabled);
                    console.log(`Etiquetas de columnas ${enabled ? 'habilitadas' : 'deshabilitadas'}`);
                } else {
                    console.warn('ColumnLabelsManager no est√° inicializado');
                }
            });

            // Handle window resize to update label positions
            window.addEventListener('resize', () => {
                if (columnLabelsManager && columnLabelsManager.isEnabled()) {
                    columnLabelsManager.handleResize();
                }
            });

            // Add event listeners for example and clear buttons
            const addExampleBtn = document.getElementById('add-example-labels-btn');
            const clearLabelsBtn = document.getElementById('clear-labels-btn');

            if (addExampleBtn) {
                addExampleBtn.addEventListener('click', addExampleLabels);
            }

            if (clearLabelsBtn) {
                clearLabelsBtn.addEventListener('click', clearAllLabels);
            }

            console.log('Controles de etiquetas de columnas inicializados');
        }

        // Funci√≥n de ejemplo para agregar etiquetas manualmente
        function addExampleLabels() {
            if (!columnLabelsManager) {
                console.warn('ColumnLabelsManager no est√° inicializado');
                return;
            }

            // Ejemplo 1: Etiqueta en la parte superior izquierda
            columnLabelsManager.addLabel('oferta', {
                title: 'Oferta',
                description: 'Fuentes de energ√≠a',
                x: 0.1,  // 10% desde la izquierda
                y: 0.05, // 5% desde arriba
                visible: true
            });

            // Ejemplo 2: Etiqueta en el centro superior
            columnLabelsManager.addLabel('transformacion', {
                title: 'Transformaci√≥n',
                description: 'Procesos de conversi√≥n',
                x: 0.5,  // 50% desde la izquierda (centro)
                y: 0.05, // 5% desde arriba
                visible: true
            });

            // Ejemplo 3: Etiqueta en la parte superior derecha
            columnLabelsManager.addLabel('consumo', {
                title: 'Consumo',
                description: 'Destino final',
                x: 0.9,  // 90% desde la izquierda
                y: 0.05, // 5% desde arriba
                visible: true
            });

            // Ejemplo 4: Etiqueta con estilo personalizado
            columnLabelsManager.addLabel('hub-central', {
                title: 'Hub Central',
                description: 'Concentraci√≥n',
                x: 0.3,  // 30% desde la izquierda
                y: 0.1,  // 10% desde arriba
                visible: true,
                customStyle: {
                    backgroundColor: 'rgba(52, 152, 219, 0.9)',
                    color: 'white',
                    fontSize: 16
                }
            });

            console.log('Etiquetas de ejemplo agregadas');
        }

        // Funci√≥n para limpiar todas las etiquetas
        function clearAllLabels() {
            if (columnLabelsManager) {
                columnLabelsManager.clearAllLabels();
                console.log('Todas las etiquetas removidas');
            }
        }

        // Initialize export controls when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeExportControls();
        });

        // Funci√≥n para actualizar el diagrama de Sankey (Etapa 1.7: A√±adir Salidas Completas)
        function updateSankey(year) {
            console.log(`Actualizando gr√°fico para el a√±o: ${year}`);

            Plotly.purge(sankeyDiv);

            function getNodeData(nodeName) {
                if (!dataManager) {
                    console.error('DataManager no est√° disponible');
                    return null;
                }
                return dataManager.getNodeData(nodeName);
            }

            const nodeData = {
                produccion: getNodeData('Producci√≥n'),
                importacion: getNodeData('Importaci√≥n'),
                variacion: getNodeData('Variaci√≥n de Inventarios'),
                exportacion: getNodeData('Exportaci√≥n'),
                ofertaInternaBruta: getNodeData('Oferta Interna Bruta'),
                energiaNoAprovechada: getNodeData('Energ√≠a No Aprovechada'),
                consumoPropio: getNodeData('Consumo Propio del Sector'),
                coquizadorasHornos: getNodeData('Coquizadoras y Hornos'),
                refineriasDespuntadoras: getNodeData('Refiner√≠as y Despuntadoras'),
                plantasGasFraccionadoras: getNodeData('Plantas de Gas y Fraccionadoras'),
                centralesElectricas: getNodeData('Centrales El√©ctricas'),
                carboelectrica: getNodeData('Carboel√©ctrica'),
                termicaConvencional: getNodeData('T√©rmica Convencional'),
                combustionInterna: getNodeData('Combusti√≥n Interna'),
                turbogas: getNodeData('Turbog√°s'),
                cicloCombinado: getNodeData('Ciclo Combinado'),
                nucleoelectrica: getNodeData('Nucleoel√©ctrica'),
                cogeneracion: getNodeData('Cogeneraci√≥n'),
                geotermica: getNodeData('Geot√©rmica'),
                eolica: getNodeData('E√≥lica'),
                solarFotovoltaica: getNodeData('Solar Fotovoltaica'),
                produccionBrutaEnergiaSecundaria: getNodeData('Producci√≥n bruta energ√≠a secundaria'),
                ofertaTotal: getNodeData('Oferta Total')
            };

            if (Object.values(nodeData).some(d => !d)) {
                console.error('Faltan datos de nodos padres');
                Plotly.react(sankeyDiv, [], { title: `Datos incompletos para ${year}` });
                return;
            }

            const labels = [];
            const nodeColors = [];
            const nodeMap = new Map();
            const primaryEnergyTotals = new Map();
            const primaryEnergyBreakdown = new Map(); // Para el desglose del popup
            const secondaryNodeBreakdowns = new Map(); // Para el desglose de nodos secundarios

            const source = [];
            const target = [];
            const value = [];
            const linkColors = [];
            const linkCustomdata = [];

            function addNode(name, color, nodeType = 'default') {
                // Verificar si el nodo ya existe
                if (nodeMap.has(name)) {
                    return nodeMap.get(name);
                }

                // Usar NodeFactory para crear el nodo si est√° disponible
                let finalColor;
                if (nodeFactory) {
                    try {
                        // Intentar obtener o crear el nodo usando NodeFactory
                        let node = nodeFactory.getNodeByName(name);
                        if (!node) {
                            // Inferir el tipo de nodo basado en el nombre
                            const inferredType = nodeFactory.inferNodeType(name);

                            // Crear configuraci√≥n del nodo
                            const nodeConfig = {
                                name: name,
                                color: null, // <-- ¬°Esta es la l√≠nea clave!
                                properties: {
                                    nodeType: nodeType
                                }
                            };

                            // Crear el nodo usando NodeFactory
                            node = nodeFactory.createNode(inferredType, nodeConfig);
                        }

                        finalColor = node.color;
                    } catch (error) {
                        console.warn(`Error creando nodo con NodeFactory para "${name}":`, error);
                        // Fallback al m√©todo anterior
                        finalColor = styleManager ?
                            (color && typeof color === 'string' ?
                                styleManager.validateColor(color) :
                                styleManager.getEnergyColor(name, nodeType)) :
                            (typeof color === 'string' ? color : '#888');
                    }
                } else {
                    // Fallback si NodeFactory no est√° disponible
                    finalColor = styleManager ?
                        (color && typeof color === 'string' ?
                            styleManager.validateColor(color) :
                            styleManager.getEnergyColor(name, nodeType)) :
                        (typeof color === 'string' ? color : '#888');
                }

                // Agregar el nodo al mapa y arrays
                const nodeIndex = labels.length;
                nodeMap.set(name, nodeIndex);
                labels.push(name);
                nodeColors.push(finalColor);

                return nodeIndex;
            }

            // --- 1. Definir Nodos Principales ---
            const importacionIndex = addNode(String('Importaci√≥n de energ√©ticos primarios'), nodeData.importacion.color);
            const variacionIndex = addNode(String('Variaci√≥n de inventarios de Energ√©ticos primarios'), nodeData.variacion.color);
            const produccionIndex = addNode(String('Producci√≥n'), nodeData.produccion.color);
            const primariosHubIndex = addNode(String('Oferta Total'), nodeData.ofertaTotal.color);
            const ofertaInternaBrutaIndex = addNode(String('Oferta Interna Bruta'), nodeData.ofertaInternaBruta.color);
            const exportacionIndex = addNode(String('Exportaci√≥n'), nodeData.exportacion.color);
            const energiaNoAprovechadaIndex = addNode(String('Energ√≠a No Aprovechada'), nodeData.energiaNoAprovechada.color);
            // const consumoPropioIndex = addNode(String('Consumo Propio del Sector'), nodeData.consumoPropio.color);
            const coquizadorasHornosIndex = addNode(String('Coquizadoras y Hornos'), nodeData.coquizadorasHornos.color);
            const refineriasDespuntadorasIndex = addNode(String('Refiner√≠as y Despuntadoras'), nodeData.refineriasDespuntadoras.color);
            const plantasGasFraccionadorasIndex = addNode(String('Plantas de Gas y Fraccionadoras'), nodeData.plantasGasFraccionadoras.color);
            const centralesElectricasIndex = addNode(String('Centrales El√©ctricas'), nodeData.centralesElectricas.color);
            const carboelectricaIndex = addNode(String('Carboel√©ctrica'), nodeData.carboelectrica.color);
            const termicaConvencionalIndex = addNode(String('T√©rmica Convencional'), nodeData.termicaConvencional.color);
            const combustionInternaIndex = addNode(String('Combusti√≥n Interna'), nodeData.combustionInterna.color);
            const turbogasIndex = addNode(String('Turbog√°s'), nodeData.turbogas.color);
            const cicloCombinadoIndex = addNode(String('Ciclo Combinado'), nodeData.cicloCombinado.color);
            const nucleoelectricaIndex = addNode(String('Nucleoel√©ctrica'), nodeData.nucleoelectrica.color);
            const cogeneracionIndex = addNode(String('Cogeneraci√≥n'), nodeData.cogeneracion.color);
            const geotermicaIndex = addNode(String('Geot√©rmica'), nodeData.geotermica.color);
            const eolicaIndex = addNode(String('E√≥lica'), nodeData.eolica.color);
            const solarFotovoltaicaIndex = addNode(String('Solar Fotovoltaica'), nodeData.solarFotovoltaica.color);
            const produccionBrutaEnergiaSecundariaIndex = addNode(String('Producci√≥n bruta energ√≠a secundaria'), nodeData.produccionBrutaEnergiaSecundaria.color);
            // --- 2. Procesar Flujos de Entrada (Fuentes -> Tipos de Energ√≠a) ---
            const linkSigns = [];
            const processParentNode = (nodeData, parentIndex, parentName, allowNegatives = false) => {
                // Ordenar nodos hijo por id_hijo de menor a mayor
                const hijosOrdenados = [...nodeData['Nodos Hijo']].sort((a, b) => {
                    // Si no existe id_hijo, lo ponemos al final
                    if (a.id_hijo === undefined) return 1;
                    if (b.id_hijo === undefined) return -1;
                    return a.id_hijo - b.id_hijo;
                });
                hijosOrdenados.forEach(child => {
                    const flowValue = child[year];
                    if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                        const childName = child['Nodo Hijo'];
                        const childColor = child.color;
                        const childIndex = addNode(childName, childColor);
                        source.push(parentIndex);
                        target.push(childIndex);
                        value.push(Math.log10(Math.abs(flowValue) + 1));
                        // El color del enlace debe ser el del nodo de energ√≠a al que fluye
                        const finalLinkColor = nodeColors[childIndex];
                        linkColors.push(finalLinkColor);

                        // Usar PopupManager para generar popup de enlace mejorado
                        if (popupManager) {
                            const linkPopup = popupManager.generateLinkPopup(
                                childName,
                                flowValue,
                                parentName,
                                childName, // El destino es el nodo hijo, no el hub
                                finalLinkColor,
                                year,
                                { flowType: 'primary_supply' }
                            );
                            linkCustomdata.push(linkPopup);
                        } else {
                            // Fallback al formato anterior
                            if (parentName === 'Variaci√≥n de inventarios de Energ√©ticos primarios') {
                                linkCustomdata.push(`${childName}: ${flowValue.toLocaleString()} PJ`);
                            } else {
                                linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                            }
                        }
                        linkSigns.push(flowValue > 0 ? '+' : '-');

                        // Actualizar totales y desglose
                        primaryEnergyTotals.set(childName, (primaryEnergyTotals.get(childName) || 0) + flowValue);

                        if (!primaryEnergyBreakdown.has(childName)) {
                            primaryEnergyBreakdown.set(childName, { importacion: 0, variacion: 0, produccion: 0 });
                        }
                        const breakdown = primaryEnergyBreakdown.get(childName);
                        if (parentName === 'Importaci√≥n de energ√©ticos primarios') {
                            breakdown.importacion += flowValue;
                        } else if (parentName === 'Variaci√≥n de inventarios de Energ√©ticos primarios') {
                            breakdown.variacion += flowValue;
                        } else if (parentName === 'Producci√≥n') {
                            breakdown.produccion += flowValue;
                        }
                    }
                });
            };
            processParentNode(nodeData.importacion, importacionIndex, 'Importaci√≥n de energ√©ticos primarios');
            processParentNode(nodeData.variacion, variacionIndex, 'Variaci√≥n de inventarios de Energ√©ticos primarios', true);
            processParentNode(nodeData.produccion, produccionIndex, 'Producci√≥n');

            // --- 3. Procesar Flujos (Tipos de Energ√≠a -> Hub "Energ√©ticos Primarios") ---
            for (const [energyName, totalValue] of primaryEnergyTotals.entries()) {
                const energyIndex = nodeMap.get(energyName);
                const energyColor = nodeColors[energyIndex];
                source.push(energyIndex);
                target.push(primariosHubIndex);
                value.push(Math.log10(totalValue + 1));
                linkColors.push(energyColor);

                // Usar PopupManager para generar popup de enlace mejorado
                if (popupManager) {
                    const linkPopup = popupManager.generateLinkPopup(
                        energyName,
                        totalValue,
                        energyName,
                        'Oferta Total',
                        energyColor,
                        year,
                        { flowType: 'hub_distribution' }
                    );
                    linkCustomdata.push(linkPopup);
                } else {
                    // Fallback al formato anterior
                    linkCustomdata.push(`Total: ${Math.abs(totalValue).toLocaleString()} PJ`);
                }
            }

            // --- 4. Procesar Flujos (Oferta Total -> Oferta Interna Bruta) ---
            const oibBreakdown = {};
            let oibTotal = 0;
            nodeData.ofertaInternaBruta['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    const childName = child['Nodo Hijo'];
                    const energyNodeIndex = nodeMap.get(childName);
                    if (energyNodeIndex === undefined) return;

                    const link_color = nodeColors[energyNodeIndex];

                    source.push(primariosHubIndex);
                    target.push(ofertaInternaBrutaIndex);
                    value.push(Math.log10(Math.abs(flowValue) + 1));
                    linkColors.push(link_color);

                    // Usar PopupManager para generar popup de enlace mejorado
                    if (popupManager) {
                        const linkPopup = popupManager.generateLinkPopup(
                            childName,
                            flowValue,
                            'Oferta Total',
                            'Oferta Interna Bruta',
                            link_color,
                            year,
                            { flowType: 'hub_distribution' }
                        );
                        linkCustomdata.push(linkPopup);
                    } else {
                        // Fallback al formato anterior
                        linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                    }
                    oibBreakdown[childName] = (oibBreakdown[childName] || 0) + flowValue;
                    oibTotal += flowValue;
                }
            });
            secondaryNodeBreakdowns.set('Oferta Interna Bruta', { breakdown: oibBreakdown, total: oibTotal });

            // --- 5. Procesar Flujos de Salida (Oferta Total -> Exportaci√≥n) ---
            const exportacionBreakdown = {};
            let exportacionTotal = 0;
            nodeData.exportacion['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    const childName = child['Nodo Hijo'];
                    const energyNodeIndex = nodeMap.get(childName);
                    if (energyNodeIndex === undefined) return;

                    const link_color = nodeColors[energyNodeIndex];

                    source.push(primariosHubIndex);
                    target.push(exportacionIndex);
                    value.push(Math.log10(Math.abs(flowValue) + 1));
                    linkColors.push(link_color);

                    // Usar PopupManager para generar popup de enlace mejorado
                    if (popupManager) {
                        const linkPopup = popupManager.generateLinkPopup(
                            childName,
                            flowValue,
                            'Oferta Total',
                            'Exportaci√≥n',
                            link_color,
                            year,
                            { flowType: 'hub_distribution' }
                        );
                        linkCustomdata.push(linkPopup);
                    } else {
                        // Fallback al formato anterior
                        linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                    }
                    exportacionBreakdown[childName] = (exportacionBreakdown[childName] || 0) + flowValue;
                    exportacionTotal += flowValue;
                }
            });
            secondaryNodeBreakdowns.set('Exportaci√≥n', { breakdown: exportacionBreakdown, total: exportacionTotal });

            // --- 6. Procesar Flujos de Salida (Oferta Total -> Energ√≠a No Aprovechada) ---
            const enaBreakdown = {};
            let enaTotal = 0;
            nodeData.energiaNoAprovechada['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    const childName = child['Nodo Hijo'];
                    const energyNodeIndex = nodeMap.get(childName);
                    if (energyNodeIndex === undefined) return;

                    const link_color = nodeColors[energyNodeIndex];

                    source.push(primariosHubIndex);
                    target.push(energiaNoAprovechadaIndex);
                    value.push(Math.log10(Math.abs(flowValue) + 1));
                    linkColors.push(link_color);

                    // Usar PopupManager para generar popup de enlace mejorado
                    if (popupManager) {
                        const linkPopup = popupManager.generateLinkPopup(
                            childName,
                            flowValue,
                            'Oferta Total',
                            'Energ√≠a No Aprovechada',
                            link_color,
                            year,
                            { flowType: 'hub_distribution' }
                        );
                        linkCustomdata.push(linkPopup);
                    } else {
                        // Fallback al formato anterior
                        linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                    }
                    enaBreakdown[childName] = (enaBreakdown[childName] || 0) + flowValue;
                    enaTotal += flowValue;
                }
            });
            secondaryNodeBreakdowns.set('Energ√≠a No Aprovechada', { breakdown: enaBreakdown, total: enaTotal });

            // --- 7. Procesar Flujos (Oferta Interna Bruta -> Coquizadoras y Hornos) ---
            const coquizadorasBreakdown = {};
            let coquizadorasTotal = 0;
            nodeData.coquizadorasHornos['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    const childName = child['Nodo Hijo'];
                    const energyNodeIndex = nodeMap.get(childName);
                    if (energyNodeIndex === undefined) return;

                    const link_color = nodeColors[energyNodeIndex];

                    source.push(ofertaInternaBrutaIndex);
                    target.push(coquizadorasHornosIndex);
                    value.push(Math.log10(Math.abs(flowValue) + 1));
                    linkColors.push(link_color);

                    // Usar PopupManager para generar popup de enlace mejorado
                    if (popupManager) {
                        const linkPopup = popupManager.generateLinkPopup(
                            childName,
                            flowValue,
                            'Oferta Interna Bruta',
                            'Coquizadoras y Hornos',
                            link_color,
                            year,
                            { flowType: 'transformation_input' }
                        );
                        linkCustomdata.push(linkPopup);
                    } else {
                        // Fallback al formato anterior
                        linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                    }
                    coquizadorasBreakdown[childName] = (coquizadorasBreakdown[childName] || 0) + flowValue;
                    coquizadorasTotal += flowValue;
                }
            });
            secondaryNodeBreakdowns.set('Coquizadoras y Hornos', { breakdown: coquizadorasBreakdown, total: coquizadorasTotal });

            // --- 7. Procesar Flujos (Oferta Interna Bruta -> Refiner√≠as y Despuntadoras) ---
            const refineriasBreakdown = {};
            let refineriasTotal = 0;
            nodeData.refineriasDespuntadoras['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    const childName = child['Nodo Hijo'];
                    const energyNodeIndex = nodeMap.get(childName);
                    if (energyNodeIndex === undefined) return;

                    const link_color = nodeColors[energyNodeIndex];

                    source.push(ofertaInternaBrutaIndex);
                    target.push(refineriasDespuntadorasIndex);
                    value.push(Math.log10(Math.abs(flowValue) + 1));
                    linkColors.push(link_color);

                    // Usar PopupManager para generar popup de enlace mejorado
                    if (popupManager) {
                        const linkPopup = popupManager.generateLinkPopup(
                            childName,
                            flowValue,
                            'Oferta Interna Bruta',
                            'Refiner√≠as y Despuntadoras',
                            link_color,
                            year,
                            { flowType: 'transformation_input' }
                        );
                        linkCustomdata.push(linkPopup);
                    } else {
                        // Fallback al formato anterior
                        linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                    }
                    refineriasBreakdown[childName] = (refineriasBreakdown[childName] || 0) + flowValue;
                    refineriasTotal += flowValue;
                }
            });
            secondaryNodeBreakdowns.set('Refiner√≠as y Despuntadoras', { breakdown: refineriasBreakdown, total: refineriasTotal });

            // --- 8. Procesar Flujos (Oferta Interna Bruta -> Plantas de Gas y Fraccionadoras) ---
            const plantasGasBreakdown = {};
            let plantasGasTotal = 0;
            nodeData.plantasGasFraccionadoras['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    const childName = child['Nodo Hijo'];
                    const energyNodeIndex = nodeMap.get(childName);
                    if (energyNodeIndex === undefined) return;

                    const link_color = nodeColors[energyNodeIndex];

                    source.push(ofertaInternaBrutaIndex);
                    target.push(plantasGasFraccionadorasIndex);
                    value.push(Math.log10(Math.abs(flowValue) + 1));
                    linkColors.push(link_color);

                    // Usar PopupManager para generar popup de enlace mejorado
                    if (popupManager) {
                        const linkPopup = popupManager.generateLinkPopup(
                            childName,
                            flowValue,
                            'Oferta Interna Bruta',
                            'Plantas de Gas y Fraccionadoras',
                            link_color,
                            year,
                            { flowType: 'transformation_input' }
                        );
                        linkCustomdata.push(linkPopup);
                    } else {
                        // Fallback al formato anterior
                        linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                    }
                    plantasGasBreakdown[childName] = (plantasGasBreakdown[childName] || 0) + flowValue;
                    plantasGasTotal += flowValue;
                }
            });
            secondaryNodeBreakdowns.set('Plantas de Gas y Fraccionadoras', { breakdown: plantasGasBreakdown, total: plantasGasTotal });

            // --- 9. Procesar Flujos (Fuentes de Energ√≠a -> Tecnolog√≠as de Generaci√≥n) ---
            // Usar LinkManager para mapeo autom√°tico de conexiones
            if (linkManager) {
                try {
                    // Generar enlaces usando LinkManager
                    const fuelToGenerationLinks = linkManager.generateDataLinks(
                        nodeMap,
                        nodeColors,
                        nodeData,
                        year,
                        {
                            mapTypes: ['fuel-to-generation'],
                            excludeEnergyTypes: ['Energ√≠a el√©ctrica']
                        }
                    );

                    // Agregar enlaces generados a los arrays principales
                    source.push(...fuelToGenerationLinks.source);
                    target.push(...fuelToGenerationLinks.target);
                    value.push(...fuelToGenerationLinks.value);
                    linkColors.push(...fuelToGenerationLinks.linkColors);
                    linkCustomdata.push(...fuelToGenerationLinks.linkCustomdata);

                    // Generar enlaces de distribuci√≥n a transformaci√≥n (ej: Oferta Interna Bruta -> Combusti√≥n Interna)
                    const distributionToTransformationLinks = linkManager.generateDataLinks(
                        nodeMap,
                        nodeColors,
                        nodeData,
                        year,
                        {
                            mapTypes: ['distribution-to-transformation']
                        }
                    );

                    // Agregar enlaces de distribuci√≥n a transformaci√≥n
                    source.push(...distributionToTransformationLinks.source);
                    target.push(...distributionToTransformationLinks.target);
                    value.push(...distributionToTransformationLinks.value);
                    linkColors.push(...distributionToTransformationLinks.linkColors);
                    linkCustomdata.push(...distributionToTransformationLinks.linkCustomdata);

                    // Generar enlaces de centros de transformaci√≥n a tecnolog√≠as de generaci√≥n
                    // Esta l√≥gica ahora se maneja manualmente a trav√©s del hub secundario.
                    // const transformationToGenerationLinks = linkManager.generateDataLinks(
                    //     nodeMap,
                    //     nodeColors,
                    //     nodeData,
                    //     year,
                    //     {
                    //         mapTypes: ['transformation-to-generation']
                    //     }
                    // );

                    // // Agregar enlaces de transformaci√≥n a generaci√≥n
                    // source.push(...transformationToGenerationLinks.source);
                    // target.push(...transformationToGenerationLinks.target);
                    // value.push(...transformationToGenerationLinks.value);
                    // linkColors.push(...transformationToGenerationLinks.linkColors);
                    // linkCustomdata.push(...transformationToGenerationLinks.linkCustomdata);

                    console.log(`LinkManager gener√≥ ${fuelToGenerationLinks.source.length} enlaces fuel-to-generation`);
                    console.log(`LinkManager gener√≥ ${distributionToTransformationLinks.source.length} enlaces distribution-to-transformation`);
                } catch (error) {
                    console.warn('Error usando LinkManager para mapeo autom√°tico:', error);

                    // Fallback al m√©todo manual
                    const generationNodesForInput = [
                        { data: nodeData.carboelectrica, index: carboelectricaIndex, name: 'Carboel√©ctrica' },
                        { data: nodeData.termicaConvencional, index: termicaConvencionalIndex, name: 'T√©rmica Convencional' },
                        { data: nodeData.combustionInterna, index: combustionInternaIndex, name: 'Combusti√≥n Interna' },
                        { data: nodeData.turbogas, index: turbogasIndex, name: 'Turbog√°s' },
                        { data: nodeData.cicloCombinado, index: cicloCombinadoIndex, name: 'Ciclo Combinado' },
                        { data: nodeData.cogeneracion, index: cogeneracionIndex, name: 'Cogeneraci√≥n' }
                    ];

                    generationNodesForInput.forEach(genNode => {
                        if (genNode.data && genNode.data['Nodos Hijo']) {
                            genNode.data['Nodos Hijo'].forEach(fuel => {
                                const fuelName = fuel['Nodo Hijo'];
                                const fuelColor = fuel.color;
                                const flowValue = fuel[year];
                                if (flowValue !== undefined && flowValue !== 0 && fuelName !== 'Energ√≠a el√©ctrica') {
                                    const targetIndex = genNode.index;

                                    let sourceIndex;
                                    if (fuel.tipo === 'Energ√≠a Primaria') {
                                        // Para T√©rmica Convencional y Turbog√°s, conectar Bagazo de ca√±a desde Oferta Interna Bruta
                                        if (
                                            (genNode.name === 'Turbog√°s' || genNode.name === 'T√©rmica Convencional') &&
                                            fuelName === 'Bagazo de ca√±a'
                                        ) {
                                            sourceIndex = ofertaInternaBrutaIndex;
                                        } else {
                                            sourceIndex = ofertaInternaBrutaIndex;
                                        }
                                    } else { // Energ√≠a Secundaria
                                        // Ahora la fuente de energ√≠a secundaria es el hub secundario
                                        sourceIndex = produccionBrutaEnergiaSecundariaIndex;
                                    }

                                    if (sourceIndex !== undefined) {
                                        if (genNode.name === 'Turbog√°s' && fuelName === 'Bagazo de ca√±a') {
                                            console.log('DEBUG: Link Bagazo de ca√±a ‚Üí Turbog√°s', { sourceIndex, targetIndex, flowValue });
                                        }
                                        source.push(sourceIndex);
                                        target.push(targetIndex);
                                        value.push(Math.log10(Math.abs(flowValue) + 1));
                                        const validatedColor = typeof fuelColor === 'string' ? fuelColor : '#888';
                                        linkColors.push(validatedColor);

                                        // Usar PopupManager para generar popup de enlace mejorado
                                        if (popupManager) {
                                            const sourceNodeName = sourceIndex === ofertaInternaBrutaIndex ? 'Oferta Interna Bruta' :
                                                sourceIndex === coquizadorasHornosIndex ? 'Coquizadoras y Hornos' :
                                                    sourceIndex === plantasGasFraccionadorasIndex ? 'Plantas de Gas y Fraccionadoras' :
                                                        'Refiner√≠as y Despuntadoras';
                                            const linkPopup = popupManager.generateLinkPopup(
                                                fuelName,
                                                flowValue,
                                                sourceNodeName,
                                                genNode.name,
                                                validatedColor,
                                                year,
                                                { flowType: 'fuel_to_generation' }
                                            );
                                            linkCustomdata.push(linkPopup);
                                        } else {
                                            // Fallback al formato anterior
                                            linkCustomdata.push(`${fuelName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                                        }
                                    }
                                }
                            });
                        }
                    });
                }
            } else {
                console.warn('LinkManager no est√° disponible, usando m√©todo manual');

                // M√©todo manual como fallback completo
                const generationNodesForInput = [
                    { data: nodeData.carboelectrica, index: carboelectricaIndex, name: 'Carboel√©ctrica' },
                    { data: nodeData.termicaConvencional, index: termicaConvencionalIndex, name: 'T√©rmica Convencional' },
                    { data: nodeData.combustionInterna, index: combustionInternaIndex, name: 'Combusti√≥n Interna' },
                    { data: nodeData.turbogas, index: turbogasIndex, name: 'Turbog√°s' },
                    { data: nodeData.cicloCombinado, index: cicloCombinadoIndex, name: 'Ciclo Combinado' },
                    { data: nodeData.cogeneracion, index: cogeneracionIndex, name: 'Cogeneraci√≥n' }
                ];

                generationNodesForInput.forEach(genNode => {
                    if (genNode.data && genNode.data['Nodos Hijo']) {
                        genNode.data['Nodos Hijo'].forEach(fuel => {
                            const fuelName = fuel['Nodo Hijo'];
                            const fuelColor = fuel.color;
                            const flowValue = fuel[year];
                            if (flowValue !== undefined && flowValue !== 0 && fuelName !== 'Energ√≠a el√©ctrica') {
                                const targetIndex = genNode.index;

                                let sourceIndex;
                                if (fuel.tipo === 'Energ√≠a Primaria') {
                                    // Para T√©rmica Convencional y Turbog√°s, conectar Bagazo de ca√±a desde Oferta Interna Bruta
                                    if (
                                        (genNode.name === 'Turbog√°s' || genNode.name === 'T√©rmica Convencional') &&
                                        fuelName === 'Bagazo de ca√±a'
                                    ) {
                                        sourceIndex = ofertaInternaBrutaIndex;
                                    } else {
                                        sourceIndex = ofertaInternaBrutaIndex;
                                    }
                                } else { // Energ√≠a Secundaria
                                    // L√≥gica para energ√©ticos secundarios (comentada para eliminar enlaces directos a centrales el√©ctricas)
                                    // sourceIndex = produccionBrutaEnergiaSecundariaIndex; // Esto se manejar√° en una etapa posterior
                                }

                                if (sourceIndex !== undefined) {
                                    if (genNode.name === 'Turbog√°s' && fuelName === 'Bagazo de ca√±a') {
                                        console.log('DEBUG: Link Bagazo de ca√±a ‚Üí Turbog√°s', { sourceIndex, targetIndex, flowValue });
                                    }
                                    source.push(sourceIndex);
                                    target.push(targetIndex);
                                    value.push(Math.log10(Math.abs(flowValue) + 1));
                                    const validatedColor = typeof fuelColor === 'string' ? fuelColor : '#888';
                                    linkColors.push(validatedColor);

                                    // Usar PopupManager para generar popup de enlace mejorado
                                    if (popupManager) {
                                        const sourceNodeName = sourceIndex === ofertaInternaBrutaIndex ? 'Oferta Interna Bruta' :
                                            sourceIndex === coquizadorasHornosIndex ? 'Coquizadoras y Hornos' :
                                                sourceIndex === plantasGasFraccionadorasIndex ? 'Plantas de Gas y Fraccionadoras' :
                                                    'Refiner√≠as y Despuntadoras';
                                        const linkPopup = popupManager.generateLinkPopup(
                                            fuelName,
                                            flowValue,
                                            sourceNodeName,
                                            genNode.name,
                                            validatedColor,
                                            year,
                                            { flowType: 'fuel_to_generation' }
                                        );
                                        linkCustomdata.push(linkPopup);
                                    } else {
                                        // Fallback al formato anterior
                                        linkCustomdata.push(`${fuelName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                                    }
                                }
                            }
                        });
                    }
                });
            }

            // --- 10. Procesar Flujos (Tecnolog√≠as de Generaci√≥n -> Centrales El√©ctricas) ---
            // (Esta secci√≥n se mantiene igual)

            // --- 11. L√≥gica para Energ√©ticos Secundarios ---
            const secondaryEnergyTotals = new Map();
            const secondaryEnergyData = new Map(); // Para almacenar datos detallados de energ√©ticos secundarios
            const transformationCenters = [
                { name: 'Refiner√≠as y Despuntadoras', index: refineriasDespuntadorasIndex, data: nodeData.refineriasDespuntadoras },
                { name: 'Plantas de Gas y Fraccionadoras', index: plantasGasFraccionadorasIndex, data: nodeData.plantasGasFraccionadoras },
                { name: 'Coquizadoras y Hornos', index: coquizadorasHornosIndex, data: nodeData.coquizadorasHornos }
            ];

            // 11.1: Flujos de Centros de Transformaci√≥n -> Nodos de Energ√©ticos Secundarios
            transformationCenters.forEach(center => {
                center.data['Nodos Hijo'].forEach(child => {
                    const flowValue = child[year];
                    if (child.tipo === 'Energ√≠a Secundaria' && child['Nodo Hijo'] !== 'Energ√≠a el√©ctrica' && flowValue !== undefined && flowValue > 0) {
                        const childName = child['Nodo Hijo'];
                        const childColor = child.color;
                        const energyIndex = addNode(childName, childColor);

                        // Guardar datos del energ√©tico secundario para popups
                        if (!secondaryEnergyData.has(childName)) {
                            secondaryEnergyData.set(childName, {
                                name: childName,
                                tipo: child.tipo,
                                descripcion: child.descripcion || `Energ√©tico secundario del sistema energ√©tico`,
                                color: childColor,
                                sources: new Map(), // Centros de transformaci√≥n que lo producen
                                totalProduction: 0,
                                totalConsumption: 0
                            });
                        }

                        // Actualizar datos de producci√≥n
                        const energyData = secondaryEnergyData.get(childName);
                        energyData.sources.set(center.name, flowValue);
                        energyData.totalProduction += flowValue;

                        source.push(center.index);
                        target.push(energyIndex);
                        value.push(Math.log10(flowValue + 1));
                        linkColors.push(childColor);
                        linkCustomdata.push(`${center.name} -> ${childName}: ${flowValue.toLocaleString()} PJ`);

                        // Acumular el total para este energ√©tico secundario
                        secondaryEnergyTotals.set(childName, (secondaryEnergyTotals.get(childName) || 0) + flowValue);
                    }
                });
            });

            // Calcular consumo total de energ√©ticos secundarios en tecnolog√≠as de generaci√≥n
            const generationNodes = [
                { data: nodeData.carboelectrica, name: 'Carboel√©ctrica' },
                { data: nodeData.termicaConvencional, name: 'T√©rmica Convencional' },
                { data: nodeData.combustionInterna, name: 'Combusti√≥n Interna' },
                { data: nodeData.turbogas, name: 'Turbog√°s' },
                { data: nodeData.cicloCombinado, name: 'Ciclo Combinado' },
                { data: nodeData.nucleoelectrica, name: 'Nucleoel√©ctrica' },
                { data: nodeData.cogeneracion, name: 'Cogeneraci√≥n' }
            ];

            generationNodes.forEach(genNode => {
                if (genNode.data && genNode.data['Nodos Hijo']) {
                    genNode.data['Nodos Hijo'].forEach(child => {
                        const flowValue = child[year];
                        if (child.tipo === 'Energ√≠a Secundaria' && flowValue !== undefined && flowValue < 0) {
                            const energyName = child['Nodo Hijo'];
                            if (secondaryEnergyData.has(energyName)) {
                                const energyData = secondaryEnergyData.get(energyName);
                                energyData.totalConsumption += Math.abs(flowValue);
                            }
                        }
                    });
                }
            });

            // Calcular eficiencia para cada energ√©tico secundario
            for (const [energyName, energyData] of secondaryEnergyData.entries()) {
                if (energyData.totalProduction > 0) {
                    energyData.efficiency = (energyData.totalConsumption / energyData.totalProduction * 100).toFixed(1);
                } else {
                    energyData.efficiency = 0;
                }
            }

            // 11.2: Flujos de Nodos de Energ√©ticos Secundarios -> Hub Secundario
            for (const [energyName, totalValue] of secondaryEnergyTotals.entries()) {
                if (energyName === 'Energ√≠a el√©ctrica') continue; // Excluir energ√≠a el√©ctrica
                const energyIndex = nodeMap.get(energyName);
                const energyColor = nodeColors[energyIndex];

                source.push(energyIndex);
                target.push(produccionBrutaEnergiaSecundariaIndex);
                value.push(Math.log10(totalValue + 1));
                linkColors.push(energyColor);
                linkCustomdata.push(`Total ${energyName}: ${totalValue.toLocaleString()} PJ`);
            }

            // 11.3: Flujos de Hub Secundario -> Tecnolog√≠as de Generaci√≥n
            // (Esta l√≥gica se manejar√° dentro de la secci√≥n 9, la cual debe ser ajustada para tomar del hub secundario)
            // Usar LinkManager para generar enlaces de generaci√≥n a centrales
            if (linkManager) {
                try {
                    const generationToCentralesLinks = linkManager.generateDataLinks(
                        nodeMap,
                        nodeColors,
                        nodeData,
                        year,
                        {
                            mapTypes: ['generation-to-centrales']
                        }
                    );

                    // Agregar enlaces generados a los arrays principales
                    source.push(...generationToCentralesLinks.source);
                    target.push(...generationToCentralesLinks.target);
                    value.push(...generationToCentralesLinks.value);
                    linkColors.push(...generationToCentralesLinks.linkColors);
                    linkCustomdata.push(...generationToCentralesLinks.linkCustomdata);

                    console.log(`LinkManager gener√≥ ${generationToCentralesLinks.source.length} enlaces generation-to-centrales`);
                    console.log('Enlaces generation-to-centrales:', generationToCentralesLinks);
                } catch (error) {
                    console.error('Error usando LinkManager para enlaces generation-to-centrales:', error);
                    console.error('Stack trace:', error.stack);

                    // Fallback al m√©todo manual
                    const generationNodes = [
                        { data: nodeData.carboelectrica, index: carboelectricaIndex, name: 'Carboel√©ctrica' },
                        { data: nodeData.termicaConvencional, index: termicaConvencionalIndex, name: 'T√©rmica Convencional' },
                        { data: nodeData.combustionInterna, index: combustionInternaIndex, name: 'Combusti√≥n Interna' },
                        { data: nodeData.turbogas, index: turbogasIndex, name: 'Turbog√°s' },
                        { data: nodeData.cicloCombinado, index: cicloCombinadoIndex, name: 'Ciclo Combinado' },
                        { data: nodeData.cogeneracion, index: cogeneracionIndex, name: 'Cogeneraci√≥n' }
                    ];

                    generationNodes.forEach(genNode => {
                        if (genNode.data && genNode.data['Nodos Hijo']) {
                            genNode.data['Nodos Hijo'].forEach(child => {
                                if (child['Nodo Hijo'] === 'Energ√≠a el√©ctrica') {
                                    const flowValue = child[year];
                                    if (flowValue !== undefined && flowValue !== 0) {
                                        source.push(genNode.index);
                                        target.push(centralesElectricasIndex);
                                        value.push(Math.log10(Math.abs(flowValue) + 1));
                                        const validatedColor = typeof child.color === 'string' ? child.color : '#888';
                                        linkColors.push(validatedColor);

                                        // Usar PopupManager para generar popup de enlace mejorado
                                        if (popupManager) {
                                            const linkPopup = popupManager.generateLinkPopup(
                                                'Energ√≠a el√©ctrica',
                                                flowValue,
                                                genNode.name,
                                                'Centrales El√©ctricas',
                                                validatedColor,
                                                year,
                                                { flowType: 'generation_to_grid' }
                                            );
                                            linkCustomdata.push(linkPopup);
                                        } else {
                                            // Fallback al formato anterior
                                            linkCustomdata.push(`Producci√≥n de ${genNode.name}: ${Math.abs(flowValue).toLocaleString()} PJ`);
                                        }
                                    }
                                }
                            });
                        }
                    });
                }
            } else {
                console.warn('LinkManager no est√° disponible para enlaces generation-to-centrales');
            }

            // --- 13. Procesar Flujos de Salida (Oferta Total -> Consumo Propio del Sector) ---
            // nodeData.consumoPropio['Nodos Hijo'].forEach(child => {
            //     const flowValue = child[year];
            //     if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
            //         const childName = child['Nodo Hijo'];
            //         const childColor = child.color;
            //         // const energyIndex = nodeMap.get(childName); // Obtener el √≠ndice del nodo de energ√©tico primario

            //         source.push(primariosHubIndex);
            //         target.push(consumoPropioIndex);
            //         value.push(Math.log10(Math.abs(flowValue) + 1));
            //         const validatedColor = typeof childColor === 'string' ? childColor : '#888';
            //         linkColors.push(validatedColor);

            //         // Usar PopupManager para generar popup de enlace mejorado
            //         if (popupManager) {
            //             const linkPopup = popupManager.generateLinkPopup(
            //                 childName,
            //                 flowValue,
            //                 'Oferta Total (Hub)',
            //                 'Consumo Propio del Sector',
            //                 validatedColor,
            //                 year,
            //                 { flowType: 'hub_distribution' }
            //             );
            //             linkCustomdata.push(linkPopup);
            //         } else {
            //             // Fallback al formato anterior
            //             linkCustomdata.push(`${childName}: ${Math.abs(flowValue).toLocaleString()} PJ`);
            //         }
            //     }
            // });

            // --- 6. Calcular Posiciones Inteligentes con LayoutEngine ---
            const nodeX = new Array(labels.length);
            const nodeY = new Array(labels.length);

            // Calcular sumas para el nodo de variaci√≥n de inventarios (para popups)
            let variacionPositiva = 0;
            let variacionNegativa = 0;
            nodeData.variacion['Nodos Hijo'].forEach(child => {
                const flowValue = child[year];
                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                    if (flowValue > 0) variacionPositiva += flowValue;
                    if (flowValue < 0) variacionNegativa += flowValue;
                }
            });
            const variacionTotalAbs = Math.abs(variacionPositiva) + Math.abs(variacionNegativa);

            // Usar LayoutEngine para calcular posiciones inteligentes
            if (layoutEngine) {
                const calculatedPositions = layoutEngine.calculatePositions(labels);
                const optimizedPositions = layoutEngine.optimizePositions(calculatedPositions);

                // Aplicar posiciones calculadas
                labels.forEach((label, i) => {
                    const position = optimizedPositions.get(label);
                    if (position) {
                        nodeX[i] = position.x;
                        nodeY[i] = position.y;
                    } else {
                        // Posici√≥n por defecto si no se encuentra
                        nodeX[i] = 0.5;
                        nodeY[i] = 0.5;
                        console.warn(`Posici√≥n no encontrada para nodo: ${label}`);
                    }
                });

                console.log('Posiciones calculadas por LayoutEngine para', labels.length, 'nodos');
            } else {
                // Fallback a posiciones por defecto si LayoutEngine no est√° disponible
                console.warn('LayoutEngine no disponible, usando posiciones por defecto');
                labels.forEach((label, i) => {
                    nodeX[i] = 0.5;
                    nodeY[i] = i / Math.max(labels.length - 1, 1);
                });
            }

            // Custom hovertemplate for links with sign
            const customLinkHover = value.map((v, i) => {
                return `${labels[source[i]]} ‚Üí ${labels[target[i]]}<br>Signo: ${linkSigns[i] || '+'} ${v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })} PJ<extra></extra>`;
            });

            // Usar un solo string para hovertemplate de nodos
            // El PopupManager ya incluye el t√≠tulo, as√≠ que solo usamos customdata.
            const customNodeHover = '%{customdata}<extra></extra>';

            // Preparar customdata para cada nodo usando PopupManager
            let ofertaTotalHubValue = 0;
            for (const totalValue of primaryEnergyTotals.values()) {
                ofertaTotalHubValue += totalValue;
            }

            const customNodeData = labels.map(label => {
                try {
                    // Preparar datos adicionales para el popup
                    let additionalData = {};
                    let nodeDataForPopup = null;

                    // Obtener datos del nodo espec√≠fico
                    if (primaryEnergyBreakdown.has(label)) {
                        const breakdown = primaryEnergyBreakdown.get(label);
                        additionalData = {
                            importacion: breakdown.importacion,
                            variacion: breakdown.variacion,
                            produccion: breakdown.produccion,
                            total: breakdown.importacion + breakdown.variacion + breakdown.produccion,
                            description: `Energ√©tico primario con flujos de importaci√≥n, producci√≥n y variaci√≥n de inventarios`,
                            unit: 'PJ'
                        };
                    } else if (secondaryNodeBreakdowns.has(label)) {
                        const { breakdown, total } = secondaryNodeBreakdowns.get(label);
                        additionalData = {
                            breakdown: breakdown,
                            total: total,
                            description: `Nodo de consolidaci√≥n de flujos energ√©ticos`,
                            unit: 'PJ'
                        };
                    } else if (label === 'Importaci√≥n de energ√©ticos primarios') {
                        let totalImportacion = 0;
                        for (const breakdown of primaryEnergyBreakdown.values()) {
                            totalImportacion += breakdown.importacion;
                        }
                        additionalData = {
                            total_input: totalImportacion,
                            description: `Importaciones totales de energ√©ticos primarios`,
                            unit: 'PJ'
                        };
                        nodeDataForPopup = nodeData.importacion;
                    } else if (label === 'Producci√≥n') {
                        let totalProduccion = 0;
                        for (const breakdown of primaryEnergyBreakdown.values()) {
                            totalProduccion += breakdown.produccion;
                        }
                        additionalData = {
                            total_input: totalProduccion,
                            description: `Producci√≥n nacional total de energ√©ticos primarios`,
                            unit: 'PJ'
                        };
                        nodeDataForPopup = nodeData.produccion;
                    } else if (label === 'Oferta Total') {
                        additionalData = {
                            total_input: ofertaTotalHubValue,
                            total_output: ofertaTotalHubValue,
                            balance: 0,
                            description: `Hub centralizador de todos los flujos de energ√©ticos primarios`,
                            unit: 'PJ'
                        };
                        nodeDataForPopup = nodeData.ofertaTotal;
                    } else if (label === 'Variaci√≥n de inventarios de Energ√©ticos primarios') {
                        additionalData = {
                            variacion_positiva: variacionPositiva,
                            variacion_negativa: variacionNegativa,
                            total: variacionTotalAbs,
                            description: `Cambios en los inventarios de energ√©ticos primarios (+ aumento, - disminuci√≥n)`,
                            unit: 'PJ'
                        };
                        nodeDataForPopup = nodeData.variacion;
                    } else if (label === 'Consumo Propio del Sector') {
                        let totalConsumoPropio = 0;
                        if (nodeData.consumoPropio && nodeData.consumoPropio['Nodos Hijo']) {
                            nodeData.consumoPropio['Nodos Hijo'].forEach(child => {
                                const flowValue = child[year];
                                if (child.tipo === 'Energ√≠a Primaria' && flowValue !== undefined && flowValue !== 0) {
                                    totalConsumoPropio += flowValue;
                                }
                            });
                        }
                        additionalData = {
                            consumption: totalConsumoPropio,
                            sector: 'Sector Energ√©tico',
                            description: `Consumo interno del sector energ√©tico para sus propias operaciones`,
                            unit: 'PJ'
                        };
                        nodeDataForPopup = nodeData.consumoPropio;
                    } else {
                        // Verificar si es un nodo de generaci√≥n
                        const generationNodeMap = {
                            'Carboel√©ctrica': 'carboelectrica',
                            'T√©rmica Convencional': 'termicaConvencional',
                            'Combusti√≥n Interna': 'combustionInterna',
                            'Turbog√°s': 'turbogas',
                            'Ciclo Combinado': 'cicloCombinado',
                            'Nucleoel√©ctrica': 'nucleoelectrica',
                            'Cogeneraci√≥n': 'cogeneracion',
                            'Geot√©rmica': 'geotermica',
                            'E√≥lica': 'eolica',
                            'Solar Fotovoltaica': 'solarFotovoltaica'
                        };

                        if (generationNodeMap[label]) {
                            const nodeKey = generationNodeMap[label];
                            nodeDataForPopup = nodeData[nodeKey];

                            if (nodeDataForPopup && nodeDataForPopup['Nodos Hijo']) {
                                // Calcular entradas (valores negativos) y salidas (valores positivos)
                                let totalInput = 0;
                                let totalOutput = 0;

                                nodeDataForPopup['Nodos Hijo'].forEach(child => {
                                    const flowValue = child[year];
                                    if (flowValue !== undefined && flowValue !== 0) {
                                        if (flowValue < 0) {
                                            totalInput += Math.abs(flowValue);
                                        } else {
                                            totalOutput += flowValue;
                                        }
                                    }
                                });

                                additionalData = {
                                    total_input: totalInput,
                                    total_output: totalOutput,
                                    efficiency: totalInput > 0 ? (totalOutput / totalInput * 100).toFixed(1) : 0,
                                    description: `Central de generaci√≥n el√©ctrica`,
                                    unit: 'PJ'
                                };
                            }
                        } else if (secondaryEnergyData.has(label)) {
                            // Nodo de energ√©tico secundario
                            const energyData = secondaryEnergyData.get(label);
                            nodeDataForPopup = {
                                nombre: energyData.name,
                                descripcion: energyData.descripcion,
                                tipo: energyData.tipo,
                                color: energyData.color
                            };

                            additionalData = {
                                total_production: energyData.totalProduction,
                                total_consumption: energyData.totalConsumption,
                                efficiency: energyData.efficiency,
                                unit: 'PJ'
                            };
                        } else {
                            // Para otros nodos, buscar en nodeData
                            const nodeKeys = Object.keys(nodeData);
                            for (const key of nodeKeys) {
                                if (nodeData[key] && nodeData[key].nombre === label) {
                                    nodeDataForPopup = nodeData[key];
                                    break;
                                }
                            }

                            // Datos por defecto si no se encuentra informaci√≥n espec√≠fica
                            additionalData = {
                                description: `Nodo del sistema energ√©tico`,
                                unit: 'PJ'
                            };
                        }
                    }

                    // Usar PopupManager para generar el popup si est√° disponible
                    if (popupManager) {
                        return popupManager.generateNodePopup(label, nodeDataForPopup, year, additionalData);
                    } else {
                        // Fallback al formato anterior si PopupManager no est√° disponible
                        console.warn('PopupManager no disponible, usando formato b√°sico');
                        return `${label}<br>A√±o: ${year}`;
                    }
                } catch (error) {
                    console.error(`Error generando popup para nodo "${label}":`, error);
                    return `${label}<br>Error al cargar informaci√≥n`;
                }
            });

            // Convertir los colores de los enlaces para que tengan transparencia
            const transparentLinkColors = linkColors.map(hex =>
                styleManager ? styleManager.hexToRgba(hex, 0.5) : hex // Ajusta este valor (0.0 a 1.0)
            );

            const data = {
                type: "sankey",
                orientation: "h",
                node: {
                    pad: 100,      // Reducido para menor espaciado vertical
                    thickness: 10,  // Reducido para nodos m√°s delgados
                    line: { color: "black", width: 0.5 },
                    label: labels,
                    color: nodeColors,
                    hovertemplate: customNodeHover,
                    customdata: customNodeData,
                    x: nodeX,
                    y: nodeY,
                    font: { size: 6 } // Reducir el tama√±o de la fuente a√∫n m√°s
                },
                link: {
                    source: source,
                    target: target,
                    value: value,
                    color: transparentLinkColors,
                    customdata: linkCustomdata,
                    hovertemplate: '%{customdata}<extra></extra>'
                }
            };

            const layout = {
                title: `Balance Nacional de Energ√≠a - ${year} (Valores en PJ)`,
                font: { size: 12 },
                margin: { l: 10, r: 10, t: 50, b: 10 },
                autosize: true
            };
            const config = {
                displaylogo: false,
                responsive: true,
                toImageButtonOptions: {
                    format: 'png',
                    filename: `sankey_energia_primaria_${year}`,
                    setBackground: 'transparent',
                    width: 1920,
                    height: 1080,
                    scale: 1
                }
            };

            Plotly.newPlot(sankeyDiv, [data], layout, config).then(() => {
                // Renderizar etiquetas de columnas despu√©s de que el diagrama est√© listo
                if (columnLabelsManager && columnLabelsManager.isEnabled()) {
                    // Usar setTimeout para asegurar que el diagrama est√© completamente renderizado
                    setTimeout(() => {
                        columnLabelsManager.renderLabels(sankeyDiv);
                    }, 100);
                }
            }).catch(error => {
                console.error('Error al renderizar el diagrama de Sankey:', error);
            });
        }
    </script>
</body>

</html>