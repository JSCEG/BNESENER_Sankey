<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama de Sankey de Energ√≠a</title>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* Header styles */
        h1 {
            font-size: 2.5rem;
            font-weight: 300;
            color: #34495e;
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Controls container */
        .controls-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Label styles */
        label {
            font-size: 1rem;
            font-weight: 500;
            color: #34495e;
            white-space: nowrap;
        }

        /* Select dropdown styles */
        select {
            font-family: inherit;
            font-size: 1rem;
            padding: 10px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        select:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Diagram container */
        .diagram-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            width: 95%;
            margin: 0 auto;
        }

        #sankey-diagram {
            width: 100%;
            height: 85vh;
            min-height: 600px;
            border-radius: 12px;
            overflow: hidden;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
                margin-bottom: 20px;
            }

            .controls-container {
                padding: 15px 20px;
                margin-bottom: 20px;
                flex-direction: column;
                gap: 10px;
            }

            .diagram-container {
                width: 98%;
                padding: 15px;
            }

            #sankey-diagram {
                height: 75vh;
                min-height: 500px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.75rem;
            }

            .controls-container {
                padding: 12px 15px;
            }

            .diagram-container {
                width: 100%;
                padding: 12px;
            }

            #sankey-diagram {
                height: 70vh;
                min-height: 450px;
            }

            select {
                font-size: 0.9rem;
                padding: 8px 12px;
                min-width: 100px;
            }
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Error state */
        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            body {
                background: white;
                color: black;
            }

            .controls-container,
            .diagram-container {
                background: white;
                border: 2px solid black;
            }

            select {
                border: 2px solid black;
            }
        }

        /* Column Labels Controls Styles */
        .column-labels-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-labels-controls label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }

        .column-labels-controls input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #3498db;
        }

        /* Column Label Styles */
        .column-label {
            position: absolute;
            z-index: 1000;
            pointer-events: none;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .column-label-title {
            margin: 0;
            line-height: 1.2;
            font-weight: 600;
        }

        .column-label-description {
            margin: 2px 0 0 0;
            line-height: 1.1;
            opacity: 0.7;
            font-size: 0.8em;
        }

        /* Export Controls Styles */
        .export-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .export-btn {
            font-family: inherit;
            font-size: 0.9rem;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .config-btn {
            background: #6c757d;
            color: white;
        }

        .config-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .png-btn {
            background: #28a745;
            color: white;
        }

        .png-btn:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .svg-btn {
            background: #007bff;
            color: white;
        }

        .svg-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
            font-weight: 600;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .modal-body {
            padding: 25px;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-section h4 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .config-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .config-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #495057;
        }

        .config-group input[type="number"],
        .config-group input[type="text"],
        .config-group select {
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .config-group input[type="number"]:focus,
        .config-group input[type="text"]:focus,
        .config-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .config-group input[type="checkbox"] {
            margin-right: 8px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Progress Modal Styles */
        .progress-modal {
            max-width: 400px;
            text-align: center;
        }

        .progress-content {
            padding: 30px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-content h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .progress-content p {
            margin: 0 0 20px 0;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Responsive adjustments for export controls */
        @media (max-width: 768px) {
            .export-controls {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }

            .export-btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }

        @media (max-width: 480px) {
            .export-controls {
                flex-direction: column;
                gap: 8px;
            }

            .export-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                color: #ecf0f1;
            }

            h1 {
                color: #ecf0f1;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            }

            .controls-container,
            .diagram-container {
                background: rgba(44, 62, 80, 0.95);
                border: 1px solid rgba(236, 240, 241, 0.1);
            }

            label {
                color: #ecf0f1;
            }

            select {
                background: #34495e;
                color: #ecf0f1;
                border-color: #4a6741;
            }

            select:hover {
                border-color: #5dade2;
            }

            .error {
                background: #4a2c2a;
                border-color: #8b4513;
                color: #ff6b6b;
            }

            .modal-content {
                background: #34495e;
                color: #ecf0f1;
            }

            .modal-header {
                border-bottom-color: #4a6741;
            }

            .modal-header h3 {
                color: #ecf0f1;
            }

            .modal-footer {
                border-top-color: #4a6741;
            }

            .config-section h4 {
                color: #ecf0f1;
            }

            .config-group label {
                color: #ecf0f1;
            }

            .config-group input[type="number"],
            .config-group input[type="text"],
            .config-group select {
                background: #2c3e50;
                color: #ecf0f1;
                border-color: #4a6741;
            }

            .progress-content h3 {
                color: #ecf0f1;
            }

            .progress-content p {
                color: #bdc3c7;
            }
        }
    </style>
</head>

<body>
    <h1>Diagrama de Sankey de Energ√≠a en M√©xico</h1>
    <div class="controls-container">
        <label for="year-selector">Selecciona un a√±o:</label>
        <select id="year-selector"></select>

        <!-- Column Labels Controls -->
        <div class="column-labels-controls">
            <label>
                <input type="checkbox" id="column-labels-toggle">
                Mostrar etiquetas de columnas
            </label>
            <button id="add-example-labels-btn" class="export-btn config-btn"
                style="font-size: 0.8rem; padding: 6px 12px;">
                + Agregar Ejemplos
            </button>
            <button id="clear-labels-btn" class="export-btn"
                style="background: #dc3545; color: white; font-size: 0.8rem; padding: 6px 12px;">
                üóëÔ∏è Limpiar
            </button>
        </div>

        <!-- Export Controls -->
        <div class="export-controls">
            <button id="export-config-btn" class="export-btn config-btn">‚öôÔ∏è Configurar Exportaci√≥n</button>
            <button id="export-png-btn" class="export-btn png-btn">üì∑ Exportar PNG</button>
            <button id="export-svg-btn" class="export-btn svg-btn">üìÑ Exportar SVG</button>
        </div>
    </div>

    <!-- Export Configuration Modal -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Configuraci√≥n de Exportaci√≥n</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h4>Resoluci√≥n PNG</h4>
                    <div class="config-group">
                        <label for="png-width">Ancho (px):</label>
                        <input type="number" id="png-width" value="1920" min="800" max="4000" step="100">
                    </div>
                    <div class="config-group">
                        <label for="png-height">Alto (px):</label>
                        <input type="number" id="png-height" value="1080" min="600" max="3000" step="100">
                    </div>
                    <div class="config-group">
                        <label for="png-scale">Escala:</label>
                        <select id="png-scale">
                            <option value="1">1x (Normal)</option>
                            <option value="2" selected>2x (Alta calidad)</option>
                            <option value="3">3x (Muy alta calidad)</option>
                        </select>
                    </div>
                </div>

                <div class="config-section">
                    <h4>Opciones Generales</h4>
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="transparent-bg" checked>
                            Fondo transparente (PNG)
                        </label>
                    </div>
                    <div class="config-group">
                        <label>
                            <input type="checkbox" id="include-column-labels" checked>
                            Incluir etiquetas de columnas en exportaci√≥n
                        </label>
                    </div>
                    <div class="config-group">
                        <label for="filename-prefix">Prefijo del archivo:</label>
                        <input type="text" id="filename-prefix" value="sankey_energia" placeholder="sankey_energia">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-config-btn" class="btn-primary">Guardar Configuraci√≥n</button>
                <button id="cancel-config-btn" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Export Progress Modal -->
    <div id="export-progress-modal" class="modal">
        <div class="modal-content progress-modal">
            <div class="progress-content">
                <div class="spinner"></div>
                <h3 id="progress-title">Exportando...</h3>
                <p id="progress-message">Preparando imagen para descarga</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="diagram-container">
        <div id="sankey-diagram"></div>
    </div>

    <!-- Incluir los m√≥dulos -->
    <script src="js/DataManager.js"></script>
    <script src="js/StyleManager.js"></script>
    <script src="js/LayoutEngine.js"></script>
    <script src="js/NodeFactory.js"></script>
    <script src="js/LinkManager.js"></script>
    <script src="js/PopupManager.js"></script>
    <script src="js/ExportManager.js"></script>
    <script src="js/ColumnLabelsManager.js"></script>

    <script>
        const yearSelector = document.getElementById('year-selector');
        const sankeyDiv = document.getElementById('sankey-diagram');
        let dataManager = null;
        let styleManager = null;
        let layoutEngine = null;
        let nodeFactory = null;
        let linkManager = null;
        let popupManager = null;
        let exportManager = null;
        let columnLabelsManager = null;

        // Export Configuration Management
        let exportConfig = {
            png: {
                width: 1920,
                height: 1080,
                scale: 2
            },
            transparentBg: true,
            includeColumnLabels: true,
            filenamePrefix: 'sankey_energia'
        };

        // Cargar los datos desde el archivo JSON y inicializar DataManager
        fetch('datos_energia_completo.json')
            .then(response => response.json())
            .then(data => {
                try {
                    // Inicializar DataManager con los datos cargados
                    dataManager = new DataManager(data);

                    // Inicializar StyleManager
                    styleManager = new StyleManager();

                    // Inicializar LayoutEngine
                    layoutEngine = new LayoutEngine();

                    // Inicializar LinkManager con referencias a otros m√≥dulos
                    linkManager = new LinkManager({
                        dataManager: dataManager,
                        styleManager: styleManager,
                        nodeFactory: null, // Se asignar√° despu√©s
                        popupManager: null // Se asignar√° despu√©s
                    });

                    // Inicializar NodeFactory con referencias a otros m√≥dulos
                    nodeFactory = new NodeFactory({
                        dataManager: dataManager,
                        styleManager: styleManager,
                        layoutEngine: layoutEngine,
                        linkManager: linkManager
                    });

                    // Asignar NodeFactory al LinkManager
                    linkManager.nodeFactory = nodeFactory;

                    // Inicializar PopupManager con referencias a otros m√≥dulos
                    popupManager = new PopupManager({
                        dataManager: dataManager,
                        styleManager: styleManager,
                        nodeFactory: nodeFactory
                    });

                    // Asignar PopupManager al LinkManager
                    linkManager.popupManager = popupManager;

                    // Inicializar ColumnLabelsManager con referencias a otros m√≥dulos
                    columnLabelsManager = new ColumnLabelsManager({
                        enabled: false, // Inicialmente deshabilitado
                        layoutEngine: layoutEngine,
                        styleManager: styleManager
                    });

                    // Aplicar tema por defecto y estilos de popup
                    styleManager.applyTheme();
                    popupManager.applyPopupStyles();

                    // Mostrar estad√≠sticas de los datos cargados
                    const stats = dataManager.getDataStats();
                    console.log('Datos cargados:', stats);
                    console.log('StyleManager inicializado con', Object.keys(styleManager.getAllColors()).length, 'colores');

                    // Mostrar estad√≠sticas del LayoutEngine
                    const layoutStats = layoutEngine.getLayoutStats();
                    console.log('LayoutEngine inicializado con', layoutStats.totalColumns, 'columnas');

                    // Mostrar estad√≠sticas del NodeFactory
                    const nodeFactoryStats = nodeFactory.getNodeStats();
                    console.log('NodeFactory inicializado con', nodeFactory.getRegisteredTypes().length, 'tipos de nodos registrados');

                    populateYearSelector();
                    // Inicializar controles de etiquetas de columnas
                    initializeColumnLabelsControls();
                    // Inicializar el gr√°fico con el primer a√±o disponible
                    updateSankey(yearSelector.value);

                    // Inicializar ExportManager despu√©s de que el diagrama est√© listo
                    setTimeout(() => {
                        try {
                            exportManager = new ExportManager(sankeyDiv, exportConfig, columnLabelsManager);
                            console.log('ExportManager inicializado correctamente con soporte para etiquetas de columnas');
                        } catch (error) {
                            console.error('Error inicializando ExportManager:', error);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Error al inicializar DataManager:', error);
                    alert('Error al cargar los datos. Por favor, recarga la p√°gina.');
                }
            })
            .catch(error => {
                console.error('Error al cargar el JSON:', error);
                alert('Error al cargar el archivo de datos. Verifica que el archivo existe.');
            });

        // Poblar el selector de a√±os din√°micamente usando DataManager
        function populateYearSelector() {
            if (!dataManager) {
                console.error('DataManager no est√° inicializado');
                return;
            }

            // Usar el m√©todo del DataManager para obtener a√±os disponibles
            const sortedYears = dataManager.getAvailableYears();

            // Limpiar opciones existentes
            yearSelector.innerHTML = '';

            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelector.appendChild(option);
            });

            // A√±adir el evento para actualizar el gr√°fico cuando cambia el a√±o
            yearSelector.addEventListener('change', (event) => {
                updateSankey(event.target.value);
            });
        }

        // Initialize export functionality
        function initializeExportControls() {
            const exportConfigBtn = document.getElementById('export-config-btn');
            const exportPngBtn = document.getElementById('export-png-btn');
            const exportSvgBtn = document.getElementById('export-svg-btn');
            const exportModal = document.getElementById('export-modal');
            const exportProgressModal = document.getElementById('export-progress-modal');
            const closeBtn = document.querySelector('.close');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const cancelConfigBtn = document.getElementById('cancel-config-btn');

            // Open configuration modal
            exportConfigBtn.addEventListener('click', () => {
                loadConfigToModal();
                exportModal.style.display = 'block';
            });

            // Close modal events
            closeBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });

            cancelConfigBtn.addEventListener('click', () => {
                exportModal.style.display = 'none';
            });

            // Close modal when clicking outside
            window.addEventListener('click', (event) => {
                if (event.target === exportModal) {
                    exportModal.style.display = 'none';
                }
                if (event.target === exportProgressModal) {
                    exportProgressModal.style.display = 'none';
                }
            });

            // Save configuration
            saveConfigBtn.addEventListener('click', () => {
                saveConfigFromModal();
                exportModal.style.display = 'none';
            });

            // Export PNG
            exportPngBtn.addEventListener('click', () => {
                exportDiagram('png');
            });

            // Export SVG
            exportSvgBtn.addEventListener('click', () => {
                exportDiagram('svg');
            });
        }

        // Load current config to modal
        function loadConfigToModal() {
            document.getElementById('png-width').value = exportConfig.png.width;
            document.getElementById('png-height').value = exportConfig.png.height;
            document.getElementById('png-scale').value = exportConfig.png.scale;
            document.getElementById('transparent-bg').checked = exportConfig.transparentBg;
            document.getElementById('include-column-labels').checked = exportConfig.includeColumnLabels !== false;
            document.getElementById('filename-prefix').value = exportConfig.filenamePrefix;
        }

        // Save config from modal
        function saveConfigFromModal() {
            exportConfig.png.width = parseInt(document.getElementById('png-width').value);
            exportConfig.png.height = parseInt(document.getElementById('png-height').value);
            exportConfig.png.scale = parseInt(document.getElementById('png-scale').value);
            exportConfig.transparentBg = document.getElementById('transparent-bg').checked;
            exportConfig.includeColumnLabels = document.getElementById('include-column-labels').checked;
            exportConfig.filenamePrefix = document.getElementById('filename-prefix').value || 'sankey_energia';

            // Update ExportManager configuration if it's initialized
            if (exportManager) {
                exportManager.updateConfig(exportConfig);
                console.log('ExportManager configuration updated:', exportConfig);
            }
        }

        // Show progress modal
        function showProgressModal(format) {
            const progressModal = document.getElementById('export-progress-modal');
            const progressTitle = document.getElementById('progress-title');
            const progressMessage = document.getElementById('progress-message');
            const progressFill = document.getElementById('progress-fill');

            progressTitle.textContent = `Exportando ${format.toUpperCase()}...`;
            progressMessage.textContent = 'Preparando imagen para descarga';
            progressFill.style.width = '0%';
            progressModal.style.display = 'block';

            return {
                updateProgress: (percent, message) => {
                    progressFill.style.width = `${percent}%`;
                    if (message) progressMessage.textContent = message;
                },
                close: () => {
                    progressModal.style.display = 'none';
                }
            };
        }

        // Export diagram function using ExportManager
        async function exportDiagram(format) {
            if (!exportManager) {
                alert('ExportManager no est√° inicializado. Por favor, espera a que se cargue completamente.');
                return;
            }

            if (!exportManager.isDiagramReady()) {
                alert('El diagrama no est√° listo para exportar. Por favor, espera a que se cargue completamente.');
                return;
            }

            const progress = showProgressModal(format);
            const currentYear = yearSelector.value;

            try {
                // Disable export buttons during export
                setExportButtonsState(false);

                // Update ExportManager configuration
                exportManager.updateConfig(exportConfig);

                // Prepare export options with current year in filename
                const exportOptions = {
                    filename: `${exportConfig.filenamePrefix}_${currentYear}`
                };

                let result;
                if (format === 'png') {
                    // Export PNG using ExportManager
                    result = await exportManager.exportToPNG(exportOptions, (percent, message) => {
                        progress.updateProgress(percent, message);
                    });
                } else if (format === 'svg') {
                    // Export SVG using ExportManager
                    result = await exportManager.exportToSVG(exportOptions, (percent, message) => {
                        progress.updateProgress(percent, message);
                    });
                } else {
                    throw new Error(`Formato no soportado: ${format}`);
                }

                // Show success message
                console.log(`Exportaci√≥n ${format.toUpperCase()} exitosa:`, result);

                // Close progress modal after a short delay
                setTimeout(() => {
                    progress.close();
                }, 1000);

            } catch (error) {
                console.error('Error durante la exportaci√≥n:', error);
                progress.close();

                let errorMessage = 'Error desconocido durante la exportaci√≥n';
                if (error.message) {
                    errorMessage = error.message;
                } else if (typeof error === 'string') {
                    errorMessage = error;
                }

                alert(`Error al exportar ${format.toUpperCase()}: ${errorMessage}`);
            } finally {
                // Re-enable export buttons
                setExportButtonsState(true);
            }
        }

        // Enable/disable export buttons
        function setExportButtonsState(enabled) {
            const exportButtons = document.querySelectorAll('.export-btn');
            exportButtons.forEach(btn => {
                btn.disabled = !enabled;
            });
        }

        // Initialize column labels controls
        function initializeColumnLabelsControls() {
            const columnLabelsToggle = document.getElementById('column-labels-toggle');

            if (!columnLabelsToggle) {
                console.warn('Column labels toggle not found');
                return;
            }

            // Add event listener for toggle
            columnLabelsToggle.addEventListener('change', (event) => {
                const enabled = event.target.checked;

                if (columnLabelsManager) {
                    columnLabelsManager.setEnabled(enabled);
                    console.log(`Etiquetas de columnas ${enabled ? 'habilitadas' : 'deshabilitadas'}`);
                } else {
                    console.warn('ColumnLabelsManager no est√° inicializado');
                }
            });

            // Handle window resize to update label positions
            window.addEventListener('resize', () => {
                if (columnLabelsManager && columnLabelsManager.isEnabled()) {
                    columnLabelsManager.handleResize();
                }
            });

            // Add event listeners for example and clear buttons
            const addExampleBtn = document.getElementById('add-example-labels-btn');
            const clearLabelsBtn = document.getElementById('clear-labels-btn');

            if (addExampleBtn) {
                addExampleBtn.addEventListener('click', addExampleLabels);
            }

            if (clearLabelsBtn) {
                clearLabelsBtn.addEventListener('click', clearAllLabels);
            }

            console.log('Controles de etiquetas de columnas inicializados');
        }

        // Funci√≥n de ejemplo para agregar etiquetas manualmente
        function addExampleLabels() {
            if (!columnLabelsManager) {
                console.warn('ColumnLabelsManager no est√° inicializado');
                return;
            }

            // Ejemplo 1: Etiqueta en la parte superior izquierda
            columnLabelsManager.addLabel('oferta', {
                title: 'Oferta',
                description: 'Fuentes de energ√≠a',
                x: 0.1,  // 10% desde la izquierda
                y: 0.05, // 5% desde arriba
                visible: true
            });

            // Ejemplo 2: Etiqueta en el centro superior
            columnLabelsManager.addLabel('transformacion', {
                title: 'Transformaci√≥n',
                description: 'Procesos de conversi√≥n',
                x: 0.5,  // 50% desde la izquierda (centro)
                y: 0.05, // 5% desde arriba
                visible: true
            });

            // Ejemplo 3: Etiqueta en la parte superior derecha
            columnLabelsManager.addLabel('consumo', {
                title: 'Consumo',
                description: 'Destino final',
                x: 0.9,  // 90% desde la izquierda
                y: 0.05, // 5% desde arriba
                visible: true
            });

            // Ejemplo 4: Etiqueta con estilo personalizado
            columnLabelsManager.addLabel('hub-central', {
                title: 'Hub Central',
                description: 'Concentraci√≥n',
                x: 0.3,  // 30% desde la izquierda
                y: 0.1,  // 10% desde arriba
                visible: true,
                customStyle: {
                    backgroundColor: 'rgba(52, 152, 219, 0.9)',
                    color: 'white',
                    fontSize: 16
                }
            });

            console.log('Etiquetas de ejemplo agregadas');
        }

        // Funci√≥n para limpiar todas las etiquetas
        function clearAllLabels() {
            if (columnLabelsManager) {
                columnLabelsManager.clearAllLabels();
                console.log('Todas las etiquetas removidas');
            }
        }

        // Initialize export controls when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            initializeExportControls();
        });

        // Funci√≥n para actualizar el diagrama de Sankey (Etapa 1.7: A√±adir Salidas Completas)
        function updateSankey(year) {
            console.log(`Actualizando gr√°fico para el a√±o: ${year}`);

            Plotly.purge(sankeyDiv);

            const labels = [];
            const nodeColors = [];
            const nodeMap = new Map();
            const nodeX = []; // Inicializar arrays de posiciones
            const nodeY = []; // Inicializar arrays de posiciones
            const nodeCustomdata = []; // Nuevo array para el customdata de cada nodo

            // --- ARRAYS PARA LOS ENLACES DEL DIAGRAMA SANKEY ---
            const source = [];
            const target = [];
            const value = [];
            const linkColors = [];
            const linkCustomdata = [];

            function addNode(name, color, nodeType = 'default') {
                if (nodeMap.has(name)) {
                    return nodeMap.get(name);
                }
                let finalColor = color;
                if (styleManager) {
                    finalColor = styleManager.getEnergyColor(name, nodeType) || color;
                }

                const nodeIndex = labels.length;
                nodeMap.set(name, nodeIndex);
                labels.push(name);
                nodeColors.push(finalColor);
                nodeCustomdata.push(''); // Inicializar con placeholder, se llenar√° despu√©s
                return nodeIndex;
            }

            // --- AQU√ç EMPEZAREMOS A CREAR Y POSICIONAR LOS NODOS ---
            const importacionNodeData = dataManager.getNodeData('Importaci√≥n');
            if (importacionNodeData) {
                const importacionIndex = addNode(importacionNodeData['Nodo Padre'], importacionNodeData.color);
                nodeX[importacionIndex] = 0.05;
                nodeY[importacionIndex] = 0.3; // Ahora el m√°s arriba
                // Generar customdata espec√≠fico para Importaci√≥n
                const importacionBreakdownForPopup = popupManager.calculateNodeBreakdown(importacionNodeData, year, 'Energ√≠a Primaria');
                console.log(`[DEBUG - Importaci√≥n] Breakdown (Primaria) para ${year}:`, importacionBreakdownForPopup);
                nodeCustomdata[importacionIndex] = popupManager.generateNodePopup(
                    importacionNodeData['Nodo Padre'],
                    importacionNodeData, // Pasar todos los datos del nodo padre para la descripci√≥n
                    year,
                    importacionBreakdownForPopup, // Pasar el breakdown calculado como additionalData
                    'text',
                    'Energ√≠a Primaria'
                );
            } else {
                console.error("Error: Datos para 'Importaci√≥n' no encontrados en DataManager.");
            }

            const produccionNodeData = dataManager.getNodeData('Producci√≥n');
            if (produccionNodeData) {
                const produccionIndex = addNode(produccionNodeData['Nodo Padre'], produccionNodeData.color);
                nodeX[produccionIndex] = 0.05;
                nodeY[produccionIndex] = 0.7; // Ahora el m√°s abajo
                // Generar customdata espec√≠fico para Producci√≥n
                const produccionBreakdownForPopup = popupManager.calculateNodeBreakdown(produccionNodeData, year, 'Energ√≠a Primaria');
                console.log(`[DEBUG - Producci√≥n] Breakdown (Primaria) para ${year}:`, produccionBreakdownForPopup);
                nodeCustomdata[produccionIndex] = popupManager.generateNodePopup(
                    produccionNodeData['Nodo Padre'],
                    produccionNodeData,
                    year,
                    produccionBreakdownForPopup,
                    'text',
                    'Energ√≠a Primaria'
                );
            } else {
                console.error("Error: Datos para 'Producci√≥n' no encontrados en DataManager.");
            }

            // Agregar Variaci√≥n de Inventarios
            const variacionNodeData = dataManager.getNodeData('Variaci√≥n de Inventarios');
            if (variacionNodeData) {
                const variacionIndex = addNode(variacionNodeData['Nodo Padre'], variacionNodeData.color);
                nodeX[variacionIndex] = 0.05;
                nodeY[variacionIndex] = 0.5; // Ahora en el medio

                // Calcular el desglose completo para la variaci√≥n de inventarios para el popup
                const variacionBreakdownForPopup = popupManager.calculateNodeBreakdown(variacionNodeData, year, 'Energ√≠a Primaria');
                console.log(`[DEBUG - Variaci√≥n de Inventarios] Breakdown Total (Primaria) para ${year}:`, variacionBreakdownForPopup.total);

                let variacionPopupData = {};

                // Preparar los campos de incremento/decremento para el popup
                // Usar input_total para la variaci√≥n positiva y output_total para la negativa
                if (variacionBreakdownForPopup.input_total > 0) {
                    variacionPopupData.variacion_positiva = variacionBreakdownForPopup.input_total;
                }
                if (variacionBreakdownForPopup.output_total > 0) {
                    variacionPopupData.variacion_negativa = variacionBreakdownForPopup.output_total;
                }
                // No pasar el valor total neto, ya que se mostrar√°n los componentes separados
                // variacionPopupData.total = variacionBreakdownForPopup.total;
                console.log(`[DEBUG - Variaci√≥n de Inventarios] Datos para popup:`, variacionPopupData);

                // Generar customdata espec√≠fico para Variaci√≥n de Inventarios
                nodeCustomdata[variacionIndex] = popupManager.generateNodePopup(
                    variacionNodeData['Nodo Padre'],
                    variacionNodeData,
                    year,
                    variacionPopupData, // Pasar los datos de variaci√≥n espec√≠ficos
                    'text',
                    'Energ√≠a Primaria'
                );
            } else {
                console.error("Error: Datos para 'Variaci√≥n de Inventarios' no encontrados en DataManager.");
            }

            // --- Nodos de Energ√©ticos Primarios de Oferta Interna Bruta ---
            const ofertaInternaBrutaFullData = dataManager.getNodeData('Oferta Interna Bruta');
            const energeticNodesMap = new Map(); // Para almacenar los √≠ndices de los nuevos nodos de energ√©ticos

            if (ofertaInternaBrutaFullData && ofertaInternaBrutaFullData['Nodos Hijo']) {
                const primaryEnergetics = ofertaInternaBrutaFullData['Nodos Hijo'].filter(child => child.tipo === 'Energ√≠a Primaria');

                // Calcular posiciones Y para distribuir los nodos de energ√©ticos
                const startY = 0.1; // Posici√≥n inicial
                const endY = 0.9;   // Posici√≥n final
                const stepY = (endY - startY) / (primaryEnergetics.length - 1 || 1); // Paso entre nodos

                primaryEnergetics.forEach((energetic, index) => {
                    const energeticName = energetic['Nodo Hijo'];
                    const energeticColor = styleManager.getEnergyColor(energeticName) || energetic.color; // Obtener color del StyleManager o del dato

                    const energeticIndex = addNode(energeticName, energeticColor);
                    energeticNodesMap.set(energeticName, energeticIndex); // Guardar el √≠ndice

                    nodeX[energeticIndex] = 0.3; // Columna de Oferta Interna Bruta
                    nodeY[energeticIndex] = startY + (index * stepY); // Distribuir verticalmente

                    // Generar customdata sencillo para cada energ√©tico
                    const energeticValue = dataManager.getEnergeticValue('Oferta Interna Bruta', energeticName, year);
                    let energeticPopupData = {};
                    if (energeticValue !== null) {
                        energeticPopupData.total = energeticValue; // Usar 'total' para el simple_source template
                    }

                    nodeCustomdata[energeticIndex] = popupManager.generateNodePopup(
                        energeticName,
                        {},
                        year,
                        energeticPopupData,
                        'text',
                        'Energ√≠a Primaria',
                        'simple_source'
                    );
                });
            } else {
                console.error("Error: Datos de 'Oferta Interna Bruta' o sus hijos no encontrados para crear energ√©ticos primarios.");
            }

            // --- Nodo de Exportaci√≥n ---
            const exportacionNodeData = dataManager.getNodeData('Exportaci√≥n');
            console.log(`[DEBUG] Datos de Exportaci√≥n:`, exportacionNodeData);
            if (exportacionNodeData) {
                const exportacionIndex = addNode(exportacionNodeData['Nodo Padre'], exportacionNodeData.color);
                nodeX[exportacionIndex] = 0.6; // Posici√≥n horizontal
                nodeY[exportacionIndex] = 0.7; // Posici√≥n vertical;

                // Calcular el desglose para el popup de Exportaci√≥n (solo energ√©ticos primarios)
                const exportacionBreakdownForPopup = popupManager.calculateNodeBreakdown(exportacionNodeData, year, 'Energ√≠a Primaria');
                console.log(`[DEBUG - Exportaci√≥n] Breakdown (Primaria) para ${year}:`, exportacionBreakdownForPopup);

                nodeCustomdata[exportacionIndex] = popupManager.generateNodePopup(
                    exportacionNodeData['Nodo Padre'],
                    exportacionNodeData,
                    year,
                    exportacionBreakdownForPopup,
                    'text',
                    'Energ√≠a Primaria'
                );
            } else {
                console.error("Error: Datos para 'Exportaci√≥n' no encontrados en DataManager.");
            }

            // --- Nodo de Energ√≠a No Aprovechada ---
            const energiaNoAprovechadaNodeData = dataManager.getNodeData('Energ√≠a No Aprovechada');
            console.log(`[DEBUG] Datos de Energ√≠a No Aprovechada:`, energiaNoAprovechadaNodeData);
            if (energiaNoAprovechadaNodeData) {
                const energiaNoAprovechadaIndex = addNode(energiaNoAprovechadaNodeData['Nodo Padre'], energiaNoAprovechadaNodeData.color);
                nodeX[energiaNoAprovechadaIndex] = 0.6; // Posici√≥n horizontal
                nodeY[energiaNoAprovechadaIndex] = 0.9; // Posici√≥n vertical;

                // Calcular el desglose para el popup de Energ√≠a No Aprovechada (solo energ√©ticos primarios)
                const energiaNoAprovechadaBreakdownForPopup = popupManager.calculateNodeBreakdown(energiaNoAprovechadaNodeData, year, 'Energ√≠a Primaria');
                console.log(`[DEBUG - Energ√≠a No Aprovechada] Breakdown (Primaria) para ${year}:`, energiaNoAprovechadaBreakdownForPopup);

                nodeCustomdata[energiaNoAprovechadaIndex] = popupManager.generateNodePopup(
                    energiaNoAprovechadaNodeData['Nodo Padre'],
                    energiaNoAprovechadaNodeData,
                    year,
                    energiaNoAprovechadaBreakdownForPopup,
                    'text',
                    'Energ√≠a Primaria'
                );
            } else {
                console.error("Error: Datos para 'Energ√≠a No Aprovechada' no encontrados en DataManager.");
            }

            // --- Y AQU√ç GENERAREMOS LOS ENLACES ---
            // Enlaces de Importaci√≥n a energ√©ticos primarios de Oferta Interna Bruta
            if (importacionNodeData && ofertaInternaBrutaFullData && ofertaInternaBrutaFullData['Nodos Hijo']) {
                const primaryEnergeticsInOIB = ofertaInternaBrutaFullData['Nodos Hijo'].filter(child => child.tipo === 'Energ√≠a Primaria');

                primaryEnergeticsInOIB.forEach(energetic => {
                    const energeticName = energetic['Nodo Hijo'];
                    const energeticValueFromImportacion = dataManager.getEnergeticValue('Importaci√≥n', energeticName, year);

                    if (energeticValueFromImportacion !== null && energeticValueFromImportacion > 0) {
                        const linkColor = styleManager.getEnergyColor(energeticName) || energetic.color;
                        console.log(`[DEBUG - Enlace Importaci√≥n] Energ√©tico: ${energeticName}, Color de enlace: ${linkColor}`);
                        source.push(nodeMap.get('Importaci√≥n'));
                        target.push(energeticNodesMap.get(energeticName));
                        value.push(Math.log10(energeticValueFromImportacion + 1));
                        linkColors.push(styleManager.hexToRgba(linkColor, 0.5));
                        linkCustomdata.push(popupManager.generateLinkPopup(
                            energeticName, energeticValueFromImportacion, 'Importaci√≥n', energeticName, linkColor, year,
                            { flowType: 'primary_supply' }
                        ));
                    }
                });
            }

            // Enlaces de Producci√≥n a energ√©ticos primarios de Oferta Interna Bruta
            if (produccionNodeData && ofertaInternaBrutaFullData && ofertaInternaBrutaFullData['Nodos Hijo']) {
                const primaryEnergeticsInOIB = ofertaInternaBrutaFullData['Nodos Hijo'].filter(child => child.tipo === 'Energ√≠a Primaria');

                primaryEnergeticsInOIB.forEach(energetic => {
                    const energeticName = energetic['Nodo Hijo'];
                    const energeticValueFromProduccion = dataManager.getEnergeticValue('Producci√≥n', energeticName, year);

                    if (energeticValueFromProduccion !== null && energeticValueFromProduccion > 0) {
                        const linkColor = styleManager.getEnergyColor(energeticName) || energetic.color;
                        console.log(`[DEBUG - Enlace Producci√≥n] Energ√©tico: ${energeticName}, Color de enlace: ${linkColor}`);
                        source.push(nodeMap.get('Producci√≥n'));
                        target.push(energeticNodesMap.get(energeticName));
                        value.push(Math.log10(energeticValueFromProduccion + 1));
                        linkColors.push(styleManager.hexToRgba(linkColor, 0.5));
                        linkCustomdata.push(popupManager.generateLinkPopup(
                            energeticName, energeticValueFromProduccion, 'Producci√≥n', energeticName, linkColor, year,
                            { flowType: 'primary_supply' }
                        ));
                    }
                });
            }

            // Enlaces de Variaci√≥n de Inventarios a energ√©ticos primarios de Oferta Interna Bruta
            if (variacionNodeData && ofertaInternaBrutaFullData && ofertaInternaBrutaFullData['Nodos Hijo']) {
                const primaryEnergeticsInOIB = ofertaInternaBrutaFullData['Nodos Hijo'].filter(child => child.tipo === 'Energ√≠a Primaria');

                primaryEnergeticsInOIB.forEach(energetic => {
                    const energeticName = energetic['Nodo Hijo'];
                    const energeticValueFromVariacion = dataManager.getEnergeticValue('Variaci√≥n de Inventarios', energeticName, year);

                    // Los valores de variaci√≥n pueden ser negativos, pero Plotly espera valores positivos para `value`
                    // El signo se manejar√° en el popup.
                    if (energeticValueFromVariacion !== null && Math.abs(energeticValueFromVariacion) > 0) {
                        const linkColor = styleManager.getEnergyColor(energeticName) || energetic.color;
                        console.log(`[DEBUG - Enlace Variaci√≥n] Energ√©tico: ${energeticName}, Color de enlace: ${linkColor}`);
                        source.push(nodeMap.get('Variaci√≥n de Inventarios'));
                        target.push(energeticNodesMap.get(energeticName));
                        value.push(Math.log10(Math.abs(energeticValueFromVariacion) + 1));
                        linkColors.push(styleManager.hexToRgba(linkColor, 0.5));
                        linkCustomdata.push(popupManager.generateLinkPopup(
                            energeticName, energeticValueFromVariacion, 'Variaci√≥n de Inventarios', energeticName, linkColor, year,
                            { flowType: 'primary_supply' }
                        ));
                    }
                });
            }

            // Enlaces de energ√©ticos primarios a Exportaci√≥n
            if (exportacionNodeData && ofertaInternaBrutaFullData && ofertaInternaBrutaFullData['Nodos Hijo']) {
                const primaryEnergeticsInOIB = ofertaInternaBrutaFullData['Nodos Hijo'].filter(child => child.tipo === 'Energ√≠a Primaria');

                primaryEnergeticsInOIB.forEach(energetic => {
                    const energeticName = energetic['Nodo Hijo'];
                    const energeticValueToExportacion = dataManager.getEnergeticValue('Exportaci√≥n', energeticName, year);
                    console.log(`[DEBUG - Flujo Exportaci√≥n] ${energeticName}: ${energeticValueToExportacion}`);
                    if (energeticValueToExportacion !== null && Math.abs(energeticValueToExportacion) > 0) {
                        const linkColor = styleManager.getEnergyColor(energeticName) || energetic.color;
                        console.log(`[DEBUG - Enlace Exportaci√≥n] Energ√©tico: ${energeticName}, Color de enlace: ${linkColor}`);
                        source.push(energeticNodesMap.get(energeticName));
                        target.push(nodeMap.get('Exportaci√≥n'));
                        value.push(Math.log10(Math.abs(energeticValueToExportacion) + 1));
                        linkColors.push(styleManager.hexToRgba(linkColor, 0.5));
                        linkCustomdata.push(popupManager.generateLinkPopup(
                            energeticName, energeticValueToExportacion, energeticName, 'Exportaci√≥n', linkColor, year,
                            { flowType: 'primary_demand' }
                        ));
                    }
                });
            }

            // Enlaces de energ√©ticos primarios a Energ√≠a No Aprovechada
            if (energiaNoAprovechadaNodeData && ofertaInternaBrutaFullData && ofertaInternaBrutaFullData['Nodos Hijo']) {
                const primaryEnergeticsInOIB = ofertaInternaBrutaFullData['Nodos Hijo'].filter(child => child.tipo === 'Energ√≠a Primaria');

                primaryEnergeticsInOIB.forEach(energetic => {
                    const energeticName = energetic['Nodo Hijo'];
                    const energeticValueToNoAprovechada = dataManager.getEnergeticValue('Energ√≠a No Aprovechada', energeticName, year);
                    console.log(`[DEBUG - Flujo Energ√≠a No Aprovechada] ${energeticName}: ${energeticValueToNoAprovechada}`);
                    if (energeticValueToNoAprovechada !== null && Math.abs(energeticValueToNoAprovechada) > 0) {
                        const linkColor = styleManager.getEnergyColor(energeticName) || energetic.color;
                        console.log(`[DEBUG - Enlace Energ√≠a No Aprovechada] Energ√©tico: ${energeticName}, Color de enlace: ${linkColor}`);
                        source.push(energeticNodesMap.get(energeticName));
                        target.push(nodeMap.get('Energ√≠a No Aprovechada'));
                        value.push(Math.log10(Math.abs(energeticValueToNoAprovechada) + 1));
                        linkColors.push(styleManager.hexToRgba(linkColor, 0.5));
                        linkCustomdata.push(popupManager.generateLinkPopup(
                            energeticName, energeticValueToNoAprovechada, energeticName, 'Energ√≠a No Aprovechada', linkColor, year,
                            { flowType: 'primary_demand' }
                        ));
                    }
                });
            }

            const data = {
                type: "sankey",
                orientation: "h",
                node: {
                    pad: 100,
                    thickness: 10,
                    line: { color: "black", width: 0.5 },
                    label: labels,
                    color: nodeColors,
                    hovertemplate: '%{customdata}<extra></extra>',
                    customdata: nodeCustomdata, // Usar el nuevo array nodeCustomdata
                    x: nodeX,
                    y: nodeY
                },
                link: {
                    source: source,
                    target: target,
                    value: value,
                    color: linkColors,
                    customdata: linkCustomdata,
                    hovertemplate: '%{customdata}<extra></extra>'
                }
            };

            const layout = {
                title: `Balance Nacional de Energ√≠a - ${year} (Valores en PJ)`,
                font: { size: 12 },
                margin: { l: 10, r: 10, t: 50, b: 10 },
                autosize: true
            };
            const config = {
                displaylogo: false,
                responsive: true,
                toImageButtonOptions: {
                    format: 'png',
                    filename: `sankey_energia_primaria_${year}`,
                    setBackground: 'transparent',
                    width: 1920,
                    height: 1080,
                    scale: 1
                }
            };

            Plotly.newPlot(sankeyDiv, [data], layout, config).then(() => {
                // Renderizar etiquetas de columnas despu√©s de que el diagrama est√© listo
                if (columnLabelsManager && columnLabelsManager.isEnabled()) {
                    // Usar setTimeout para asegurar que el diagrama est√© completamente renderizado
                    setTimeout(() => {
                        columnLabelsManager.renderLabels(sankeyDiv);
                    }, 100);
                }
            }).catch(error => {
                console.error('Error al renderizar el diagrama de Sankey:', error);
            });
        }
    </script>
</body>

</html>